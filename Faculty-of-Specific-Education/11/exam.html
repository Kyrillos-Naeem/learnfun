<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>🌟 منصة الاختبارات الذكية (مؤقت لكل سؤال) 🌟</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-primary: 'Tajawal', sans-serif;
            --bg-main: #0a0f1f; 
            --bg-content: #10172b; 
            --bg-surface: #1a233d; 
            --bg-surface-hover: #253052;
            --bg-accent-glow: rgba(0, 191, 255, 0.1); 
            --text-primary: #e0e7ff; 
            --text-secondary: #a0a8c2; 
            --text-placeholder: #6b759c;
            --text-disabled: #4a5377;
            --accent-primary: #00bfff; 
            --accent-primary-hover: #00a5e0;
            --accent-secondary: #ff33a8; 
            --accent-secondary-hover: #e02da0;
            --success: #00f2a1; 
            --success-hover: #00d98f;
            --warning: #ffdd00; 
            --warning-hover: #e6c400;
            --danger: #ff4d4d;  
            --danger-hover: #e04040;
            --border-color: #2c3a63; 
            --border-color-strong: #40528b; 
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-color: rgba(0, 191, 255, 0.2); 
            --shadow-soft: 0 4px 15px -5px var(--shadow-color);
            --shadow-medium: 0 8px 30px -10px var(--shadow-color);
            --shadow-strong: 0 12px 45px -15px var(--shadow-color);
            --shadow-inset: inset 0 2px 4px rgba(0,0,0,0.2);
            --transition-cubic: cubic-bezier(0.68, -0.55, 0.27, 1.55); 
            --transition-smooth: 0.3s ease-in-out;
            --transition-fast: 0.15s ease-in-out;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-primary); background-color: var(--bg-main); color: var(--text-primary); line-height: 1.7; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 1rem; font-weight: 400; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 1400px; margin: auto; }
        .page-container { background-color: var(--bg-content); padding: 1.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-medium), 0 0 60px -20px var(--bg-accent-glow); width: 100%; margin-bottom: 2rem; border: 1px solid var(--border-color); opacity: 0; transform: translateY(30px) scale(0.98); animation: fadeInGrow 0.6s var(--transition-cubic) forwards; }
        @keyframes fadeInGrow { to { opacity: 1; transform: translateY(0) scale(1); } }
        .page-container.hidden-no-anim { display: none !important; }
        .page-container.hidden-anim { animation: fadeOutShrink 0.4s ease-out forwards; }
        @keyframes fadeOutShrink { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(20px) scale(0.98); display: none; } }
        #welcomePage .welcome-container { max-width: 700px; text-align: center; margin: 0 auto; }
        h1, h2, h3, h4 { color: var(--text-primary); margin-bottom: 0.8em; font-weight: 700; }
        h1 { font-size: clamp(2.2rem, 5vw, 3.2rem); color: var(--accent-primary); font-weight: 800; letter-spacing: -0.5px; text-shadow: 0 0 15px var(--accent-primary); margin-bottom: 1rem; }
        h2 { font-size: clamp(1.6rem, 4vw, 2.2rem); border-bottom: 2px solid var(--border-color); padding-bottom: 0.6em; margin-bottom: 1.2em;}
        h3 { font-size: clamp(1.3rem, 3.5vw, 1.8rem); color: var(--accent-primary); }
        h4 { font-size: clamp(1.1rem, 3vw, 1.4rem); }
        p { margin-bottom: 1.2em; color: var(--text-secondary); font-size: clamp(0.95rem, 2.5vw, 1.1rem); }
        ul { list-style: none; padding-right: 1.5rem; }
        ul li { padding: 0.6rem 0; position: relative; color: var(--text-secondary); font-size: clamp(0.9rem, 2.4vw, 1.05rem); }
        ul li::before { content: "💡"; color: var(--accent-primary); font-weight: bold; position: absolute; right: -1.8rem; top: 0.6rem; font-size: 1.1em; }
        .btn { background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: #ffffff; font-weight: 700; border: none; padding: clamp(0.8rem, 2.5vw, 1.1rem) clamp(1.5rem, 5vw, 2.5rem); text-align: center; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.8rem; font-size: clamp(0.95rem, 2.8vw, 1.1rem); font-family: var(--font-primary); border-radius: var(--radius-md); cursor: pointer; transition: all 0.25s var(--transition-cubic); box-shadow: 0 0 20px -5px var(--accent-primary), 0 0 20px -5px var(--accent-secondary), var(--shadow-soft); text-transform: uppercase; letter-spacing: 0.8px; position: relative; overflow: hidden; }
        .btn::before { content: ""; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.5s ease-in-out; }
        .btn:hover::before { left: 150%; }
        .btn:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 0 30px -5px var(--accent-primary), 0 0 30px -5px var(--accent-secondary), var(--shadow-medium); }
        .btn:active { transform: translateY(-2px) scale(1.01); box-shadow: 0 0 15px -5px var(--accent-primary), 0 0 15px -5px var(--accent-secondary), var(--shadow-sm); }
        .btn-secondary { background: transparent; color: var(--accent-primary); border: 2px solid var(--accent-primary); box-shadow: none; }
        .btn-secondary:hover { background: var(--accent-primary); color: var(--bg-content); border-color: var(--accent-primary); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), var(--accent-secondary)); color: #ffffff; box-shadow: 0 0 20px -5px var(--danger), 0 0 20px -5px var(--accent-secondary),var(--shadow-soft); }
        .btn-danger:hover { box-shadow: 0 0 30px -5px var(--danger), 0 0 30px -5px var(--accent-secondary), var(--shadow-medium); }
        .btn:disabled { background: var(--bg-surface); color: var(--text-disabled); cursor: not-allowed; transform: none; box-shadow: none; border: 1px solid var(--border-color); opacity: 0.5; }
        .btn .icon { width: clamp(1rem, 3vw, 1.3rem); height: clamp(1rem, 3vw, 1.3rem); fill: currentColor; }
        input[type="text"], input[type="number"], select { width: 100%; padding: clamp(0.8rem, 2.5vw, 1rem); margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background-color: var(--bg-surface); color: var(--text-primary); font-family: var(--font-primary); font-size: clamp(0.9rem, 2.5vw, 1rem); transition: all var(--transition-smooth); box-shadow: var(--shadow-inset); }
        input[type="text"]::placeholder { color: var(--text-placeholder); opacity: 0.8; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--bg-accent-glow), var(--shadow-inset); background-color: var(--bg-surface-hover); }
        label { display: block; margin-bottom: 0.8rem; font-weight: 500; color: var(--text-primary); font-size: clamp(1rem, 2.8vw, 1.15rem); }
        .input-group { margin-bottom: 1.8rem; }
        .welcome-message { font-size: clamp(1.1rem, 3vw, 1.4rem); margin-bottom: 2rem; color: var(--text-primary); font-weight: 400; }
        .instructions { background-color: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 2rem; text-align: right; border-left: 4px solid var(--accent-primary); box-shadow: var(--shadow-soft); }
        .instructions h2 { color: var(--accent-primary); font-size: clamp(1.4rem, 3.5vw, 1.8rem); }
        .user-info, .exam-options { margin-bottom: 2rem; padding: 1.5rem; background-color: var(--bg-surface); border-radius: var(--radius-md); box-shadow: var(--shadow-soft); }
        .exam-options h3 { color: var(--accent-primary); margin-bottom: 1.2rem; text-align: center; font-size: clamp(1.2rem, 3.2vw, 1.6rem); }
        #welcomeBackMessage { padding: 1.2rem; background-color: var(--bg-accent-glow); border: 1px solid var(--accent-primary); border-radius: var(--radius-md); color: var(--accent-primary); font-weight: 500; font-size: clamp(1rem, 2.8vw, 1.15rem); }
        footer { margin-top: 3rem; font-size: clamp(0.8rem, 2vw, 0.95rem); color: var(--text-secondary); opacity: 0.7; text-align: center; width: 100%;}
        .welcome-actions { display: flex; flex-direction: column; align-items: center; gap: 1.2rem; margin-top: 1.8rem; }
        .welcome-actions .btn { width: 100%; max-width: 400px; padding: clamp(1rem, 3vw, 1.2rem) 1.5rem; font-size: clamp(1rem, 3vw, 1.15rem);} 
        .exam-layout { display: flex; gap: 1.5rem; flex-direction: column; } 
        @media (min-width: 992px) { .exam-layout { flex-direction: row; gap: 2rem; } }
        .sidebar { width: 100%; flex-shrink: 0; background-color: var(--bg-surface); padding: 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-medium); border: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        @media (min-width: 992px) { .sidebar { width: 320px; margin-bottom: 0; max-height: calc(100vh - 180px); overflow-y: auto; } }
        .sidebar h2 { text-align: center; margin-top: 0; margin-bottom: 1.5rem; color: var(--text-primary); font-size: clamp(1.2rem, 3vw, 1.5rem); border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .main-content { flex-grow: 1; min-width: 0; }
        .exam-header { display: flex; flex-direction: column; gap: 1rem; align-items: stretch; padding: 1.2rem; margin-bottom: 1.8rem; background-color: var(--bg-surface); border-radius: var(--radius-md); box-shadow: var(--shadow-medium); }
        @media (min-width: 768px) { .exam-header { flex-direction: row; justify-content: space-between; align-items: center; } }
        .user-greeting { font-size: clamp(1rem, 2.8vw, 1.2rem); color: var(--text-primary); text-align: center; }
        #examUserNameDisplay { font-weight: 700; }
        .question-timer-container { font-size: clamp(1rem, 2.8vw, 1.15rem); color: var(--warning); background-color: var(--bg-main); border: 1px solid var(--warning); border-radius: var(--radius-md); padding: 0.6rem 1rem; font-weight: 700; text-align: center; margin: 0.5rem auto 1rem; min-width: 150px; }
        .question-timer-container span { min-width: 30px; display: inline-block; }
        .question-timer-container.danger-time { border-color: var(--danger); color: var(--danger); animation: pulse-question-timer 0.8s infinite alternate; }
        @keyframes pulse-question-timer { from { box-shadow: 0 0 3px var(--danger); } to { box-shadow: 0 0 10px 3px var(--danger); } }
        .progress-container { width: 100%; margin-top: 0.8rem; text-align: right; }
        .progress-bar-label { font-size: clamp(0.85rem, 2.2vw, 1rem); margin-bottom: 0.6rem; color: var(--text-secondary); }
        .progress-bar { width: 100%; background-color: var(--bg-main); border-radius: var(--radius-md); overflow: hidden; height: 1rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-inset); }
        #progressBarFill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); transition: width 0.5s cubic-bezier(0.25, 0.1, 0.25, 1); border-radius: var(--radius-md); }
        .quiz-container { background-color: var(--bg-surface); padding: clamp(1.5rem, 4vw, 2.5rem); border-radius: var(--radius-lg); box-shadow: var(--shadow-medium); opacity: 1; transform: perspective(1000px) rotateY(0deg); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .quiz-container.loading-next { opacity: 0; transform: perspective(1000px) rotateY(15deg) translateX(-50px); }
        #questionTitle { color: var(--accent-primary); border-bottom: 2px solid var(--border-color-strong); padding-bottom: 1rem; margin-bottom: 1.5rem; font-size: clamp(1.4rem, 3.5vw, 1.9rem); font-weight: 700; }
        #questionText { font-size: clamp(1.1rem, 3vw, 1.35rem); margin: 1.8rem 0; color: var(--text-primary); line-height: 1.8; }
        .question-image-container { margin: 1.5rem 0; text-align: center; }
        #questionImage { max-width: 100%; max-height: 350px; border-radius: var(--radius-md); border: 2px solid var(--border-color); box-shadow: var(--shadow-medium); }
        .hint-button-container { text-align: left; margin-bottom: 1rem; } 
        #hintBtn { font-size: clamp(0.8rem, 2.2vw, 0.9rem); padding: 0.5rem 1rem; background-color: transparent; color: var(--warning); border: 1px solid var(--warning); box-shadow: none; }
        #hintBtn:hover { background-color: var(--warning); color: var(--bg-content); }
        #hintText { display: none; margin-top: 0.8rem; padding: 1rem; background-color: var(--bg-dark); border-radius: var(--radius-sm); color: var(--text-secondary); border-left: 3px solid var(--warning); font-size: clamp(0.85rem, 2.3vw, 1rem); animation: fadeIn 0.3s ease-out; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .options-container .option { display: flex; align-items: center; background-color: var(--bg-dark); padding: clamp(1rem, 3vw, 1.2rem) clamp(1.2rem, 3.5vw, 1.5rem); margin-bottom: 1rem; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-smooth); border: 2px solid var(--border-color); color: var(--text-secondary); font-size: clamp(0.95rem, 2.8vw, 1.1rem);}
        .options-container .option:hover { background-color: var(--bg-surface-hover); transform: translateY(-3px); border-color: var(--accent-primary); box-shadow: var(--shadow-soft); }
        .options-container .option input[type="radio"] { margin-left: 1.2rem; accent-color: var(--accent-primary); width: 1.3rem; height: 1.3rem; flex-shrink: 0; }
        .options-container .option.selected { background-color: var(--bg-accent-glow); border-color: var(--accent-primary); color: var(--text-primary); font-weight: 500; box-shadow: var(--shadow-medium); transform: scale(1.02); }
        .options-container .option.correct { background-color: var(--success-bg) !important; border-color: var(--success) !important; color: var(--success); font-weight: 500; }
        .options-container .option.incorrect { background-color: var(--danger-bg) !important; border-color: var(--danger) !important; color: var(--danger); }
        .options-container .option.correct::before, .options-container .option.incorrect::before { font-size: 1.2em; margin-right: 0.8rem; }
        .options-container .option.correct::before { content: "✔ "; color: var(--success);}
        .options-container .option.incorrect::before { content: "✘ "; color: var(--danger);}
        .navigation-buttons { margin-top: 2rem; text-align: center; display: flex; flex-direction: column; gap: 1rem; }
        @media (min-width: 600px) { .navigation-buttons { flex-direction: row; justify-content: space-between; } }
        .navigation-buttons .btn { width: 100%; }
        @media (min-width: 600px) { .navigation-buttons .btn { width: auto; flex-grow: 1; min-width: 160px; } }
        #markReviewBtn.marked-active { background: var(--warning); color: var(--bg-content); border-color: var(--warning); box-shadow: 0 0 15px -5px var(--warning); }
        #markReviewBtn.marked-active:hover { background: var(--warning-hover); } 
        .btn-submit-main, .btn-submit-sidebar { width: 100%; padding: clamp(0.9rem, 2.8vw, 1.1rem) 2rem; }
        @media (min-width: 600px) { .btn-submit-main { width: auto; } }
        .btn-submit-main { display: block; margin: 2rem auto 0; }
        #resetExamBtnContainer { text-align: center; margin-top: 1.2rem; margin-bottom: 1rem; }
        #resetExamBtn { background-color: transparent; color: var(--text-secondary); border: 1px solid var(--text-secondary); font-size: clamp(0.8rem, 2.2vw, 0.9rem); padding: 0.6rem 1.2rem; box-shadow: none; }
        #resetExamBtn:hover { background-color: var(--danger-bg); color: var(--danger); border-color: var(--danger); }
        #questionNavigator { display: grid; grid-template-columns: repeat(auto-fill, minmax(clamp(45px, 10vw, 55px), 1fr)); gap: clamp(0.5rem, 2vw, 0.8rem); }
        .nav-btn { padding: clamp(0.6rem, 2vw, 0.8rem); font-size: clamp(0.9rem, 2.5vw, 1.05rem); font-weight: 700; background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-secondary); transition: all var(--transition-smooth); min-width: clamp(45px, 10vw, 55px); min-height: clamp(45px, 10vw, 55px); display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); }
        .nav-btn:hover { background-color: var(--bg-surface-hover); border-color: var(--accent-primary); color: var(--accent-primary); transform: scale(1.08); box-shadow: var(--shadow-soft); }
        .nav-btn.current { background: var(--accent-primary); color: var(--bg-content); border-color: var(--accent-primary); box-shadow: 0 0 15px var(--accent-primary), var(--shadow-medium); transform: scale(1.18); position: relative; z-index: 1; }
        .nav-btn.current::after { content: ''; position: absolute; bottom: -0.6rem; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 0.5rem solid transparent; border-right: 0.5rem solid transparent; border-top: 0.6rem solid var(--accent-primary); }
        .nav-btn.answered { background-color: var(--success); color: var(--bg-content); border-color: var(--success); }
        .nav-btn.answered:not(.current):hover { background-color: var(--success-hover); }
        .nav-btn.marked { background-color: var(--warning-bg) !important; color: var(--warning) !important; border: 2px solid var(--warning) !important; box-shadow: 0 0 10px var(--warning); }
        .nav-btn.marked.answered { border: 2px dashed var(--success) !important; }
        .nav-btn.marked.current { border: 2px solid var(--warning) !important; }
        #resultDisplayPage .main-content { width:100%; max-width: 800px; margin: 0 auto; }
        #resultDisplayPage .exam-header h2 { width: 100%; text-align: center; color: var(--accent-primary); font-size: clamp(1.5rem, 4vw, 2rem);}
        .result-container { background-color: var(--bg-content); padding: clamp(1.8rem, 5vw, 3rem); border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow-strong); margin-top: 1.5rem; border: 1px solid var(--border-color-strong); }
        .result-container h2 { color: var(--accent-primary); font-size: clamp(2rem, 5vw, 2.8rem); font-weight: 800; text-shadow: 0 0 10px var(--accent-primary); }
        .result-container p { font-size: clamp(1.1rem, 3vw, 1.4rem); margin-bottom: 1.5rem; color: var(--text-primary); }
        .result-container .score-emphasis { font-weight: 800; color: var(--accent-secondary); font-size: clamp(1.3rem, 3.5vw, 1.7rem); }
        .detailed-review { margin-top: 2.5rem; text-align: right; border-top: 2px solid var(--border-color); padding-top: 2rem; }
        .detailed-review h3 { color: var(--text-primary); margin-bottom: 1.5rem; font-size: clamp(1.4rem, 3.8vw, 1.9rem); }
        .review-item { background-color: var(--bg-dark); padding: 1.5rem; margin-bottom: 1.5rem; border-radius: var(--radius-md); border-right: 5px solid var(--border-color); transition: transform var(--transition-smooth), box-shadow var(--transition-smooth); box-shadow: var(--shadow-soft); }
        .review-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); }
        .review-item.correct-answer { border-right-color: var(--success); background-color: rgba(0, 242, 161, 0.05); } 
        .review-item.incorrect-answer { border-right-color: var(--danger); background-color: rgba(255, 77, 77, 0.05); } 
        .review-question { font-weight: 500; margin-bottom: 0.8rem; color: var(--text-primary); font-size: clamp(1rem, 2.8vw, 1.2rem); }
        .review-options p { font-size: clamp(0.9rem, 2.5vw, 1.05rem); margin-bottom: 0.6rem; color: var(--text-secondary); }
        .review-options .user-choice { font-style: italic; }
        .review-options .correct-choice { font-weight: 700; color: var(--success); }
        .review-options .user-choice.incorrect { color: var(--danger); text-decoration: line-through; }
        .review-options .user-choice.correct { color: var(--success); }
        .explanation { margin-top: 0.8rem; padding: 0.8rem; background-color: var(--bg-surface); border-radius: var(--radius-sm); font-size: clamp(0.85rem, 2.3vw, 1rem); color: var(--text-secondary); border-left: 3px solid var(--accent-secondary); } 
        @media (min-width: 768px) { .navigation-buttons .btn { width: auto; flex-grow: 0; } .btn-submit-main { width: auto;} }
        @media (max-width: 480px) { .btn { padding: 0.8rem 1.5rem; font-size: 0.9rem; } #questionTitle {font-size: 1.3rem;} #questionText {font-size: 1.1rem;} }
        ::-webkit-scrollbar { width: 0.75rem; height: 0.75rem; } 
        ::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: var(--radius-sm); } 
        ::-webkit-scrollbar-thumb { background-color: var(--accent-primary); border-radius: var(--radius-md); border: 2px solid var(--bg-dark); } 
        ::-webkit-scrollbar-thumb:hover { background-color: var(--accent-primary-hover); }
        #muteBtn { position: fixed; bottom: 1.5rem; left: 1.5rem; background-color: var(--bg-surface); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 3rem; height: 3rem; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; box-shadow: var(--shadow-medium); transition: transform var(--transition-fast), background-color var(--transition-fast); }
        #muteBtn:hover { background-color: var(--bg-surface-hover); transform: scale(1.1); }
        .modal { position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(10, 15, 31, 0.8); display: none; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-content); padding: 2rem; border: 1px solid var(--border-color-strong); width: 90%; max-width: 550px; border-radius: var(--radius-lg); box-shadow: var(--shadow-strong), 0 0 50px -10px var(--bg-accent-glow); text-align: center; animation: modalOpen 0.4s var(--transition-cubic); }
        @keyframes modalOpen { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-content p { margin-bottom: 1.5rem; font-size: clamp(1.1rem, 3vw, 1.3rem); color: var(--text-primary); line-height: 1.6; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .modal-buttons .btn { min-width: 120px; }
    </style>
</head>
<body>
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <symbol id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></symbol>
            <symbol id="icon-stats" viewBox="0 0 24 24"><path d="M3 13h2v7H3zm4-5h2v12H7zm4-7h2v19h-2zm4 3h2v16h-2zm4 5h2v11h-2z"/></symbol>
            <symbol id="icon-home" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></symbol>
            <symbol id="icon-prev" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></symbol>
            <symbol id="icon-next" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></symbol>
            <symbol id="icon-flag" viewBox="0 0 24 24"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6zm3.6 8h-3.36l-.4-2H7V6h5.6l.4 2H18v6z"/></symbol>
            <symbol id="icon-unflag" viewBox="0 0 24 24"><path d="M5 17.59l1.41 1.41L12 13.41l5.59 5.59L19 17.59 13.41 12 19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59z M14.4 6L14 4H5v13.17l2-2V6h7.6l.4 2H18V6h-3.6z"/></symbol>
            <symbol id="icon-submit" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></symbol>
            <symbol id="icon-reset" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></symbol>
            <symbol id="icon-hint" viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></symbol>
            <symbol id="icon-sound-on" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></symbol>
            <symbol id="icon-sound-off" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L7 9H3v6h4l5 5V4z"/></symbol>
        </defs>
    </svg>

    <audio id="correctSound" src="https://cdn.jsdelivr.net/gh/pixelvars/sounds/correct.mp3" preload="auto"></audio>
    <audio id="incorrectSound" src="https://cdn.jsdelivr.net/gh/pixelvars/sounds/wrong.mp3" preload="auto"></audio>
    <audio id="clickSound" src="https://cdn.jsdelivr.net/gh/pixelvars/sounds/click.mp3" preload="auto"></audio>
    <audio id="examStartSound" src="https://cdn.jsdelivr.net/gh/pixelvars/sounds/start.mp3" preload="auto"></audio>
    <audio id="examEndSound" src="https://cdn.jsdelivr.net/gh/pixelvars/sounds/complete.mp3" preload="auto"></audio>
    <audio id="hintSound" src="https://cdn.jsdelivr.net/gh/pixelvars/sounds/hint.mp3" preload="auto"></audio>

    <button id="muteBtn" aria-label="كتم/إلغاء كتم الصوت">
        <svg class="icon" id="muteIcon"><use xlink:href="#icon-sound-off"></use></svg>
    </button>

<div class="app-container">
    <div id="welcomePage" class="page-container">
        <div class="welcome-container">
            <header>
                <h1>🏆 منصة الاختبارات الذكية 🚀</h1>
            </header>
            <main>
                <p class="welcome-message">
                    أهلاً بك في عالم التحدي والمعرفة! استعد لاختبار قدراتك بأسلوب عصري وممتع.
                </p>
                <div class="instructions">
                    <h2>📝 تعليمات هامة قبل الانطلاق:</h2>
                    <ul>
                        <li>تمعن في كل سؤال قبل الإجابة، فالدقة مفتاح التفوق.</li>
                        <li>لكل سؤال مؤقت خاص، استغل وقتك بحكمة!</li>
                        <li>تنقل بحرية بين الأسئلة، أو استخدم قائمة الأسئلة للمراجعة السريعة.</li>
                        <li>علّم الأسئلة الصعبة للعودة إليها لاحقًا باستخدام زر <svg class="icon" style="width:1em; height:1em; vertical-align:middle; fill:var(--warning);"><use xlink:href="#icon-flag"></use></svg>.</li>
                    </ul>
                </div>
                <div class="user-info">
                    <div id="nameInputSection">
                        <label for="userNameInput">سجّل اسمك كبطل لهذه الجولة:</label>
                        <input type="text" id="userNameInput" placeholder="مثال: النجم الساطع">
                    </div>
                    <div id="welcomeBackMessage" style="display: none;"></div>
                </div>
                <div class="exam-options">
                    <h3>⚙️ إعدادات الاختبار ⚙️</h3>
                    <div class="input-group">
                        <label for="numQuestionsSelect">اختر عدد التحديات (الأسئلة):</label>
                        <select id="numQuestionsSelect">
                            <option value="10" data-original-text="10 تحديات">10 تحديات</option>
                            <option value="20" data-original-text="20 تحديًا">20 تحديًا</option>
                            <option value="50" data-original-text="50 تحديًا">50 تحديًا</option>
                            <option value="all" data-original-text="كل التحديات المتاحة">كل التحديات المتاحة</option>
                        </select>
                    </div>
                </div>
                <div class="welcome-actions">
                    <button id="startExamBtn" class="btn">
                        <svg class="icon"><use xlink:href="#icon-play"></use></svg>
                        ابدأ المغامرة!
                    </button>
                    <button id="showLastResultBtn" class="btn btn-secondary" style="display: none;">
                        <svg class="icon"><use xlink:href="#icon-stats"></use></svg>
                        سجل إنجازاتك
                    </button>
                </div>
            </main>
        </div>
    </div>

    <div id="examPage" class="page-container hidden-no-anim"> 
        <div class="exam-layout">
            <aside class="sidebar">
                <h2>قائمة التحديات</h2>
                 <div id="resetExamBtnContainer">
                    <button id="resetExamBtn" class="btn btn-secondary">
                        <svg class="icon" style="width:1em; height:1em;"><use xlink:href="#icon-reset"></use></svg>
                        إعادة البدء
                    </button>
                </div>
                <div id="questionNavigator"></div>
                <button id="submitExamBtnSidebar" class="btn btn-danger btn-submit-sidebar">
                     <svg class="icon"><use xlink:href="#icon-submit"></use></svg>
                    إنهاء وتسليم
                </button>
            </aside>
            <main class="main-content">
                <header class="exam-header">
                    <div class="user-greeting">مرحباً أيها البطل، <span id="examUserNameDisplay"></span>!</div>
                     <div class="question-timer-container" id="questionTimerContainer">
                        ⏳ وقت السؤال: <span id="questionTimerDisplay">30</span> ثانية
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar-label">تقدمك في الرحلة: <span id="progressText">0/0</span></div>
                        <div class="progress-bar"><div id="progressBarFill"></div></div>
                    </div>
                </header>
                <div id="quizContainer" class="quiz-container">
                    <div class="hint-button-container">
                        <button id="hintBtn" class="btn btn-secondary">
                            <svg class="icon" style="width:1em; height:1em;"><use xlink:href="#icon-hint"></use></svg>
                            طلب مساعدة
                        </button>
                    </div>
                    <div id="hintText"></div>
                    <div id="questionArea" class="question-area">
                        <h2 id="questionTitle"></h2>
                        <p id="questionText"></p>
                        <div id="questionImageContainer" style="display:none;"><img id="questionImage" src="" alt="صورة السؤال"></div>
                        <div id="optionsContainer" class="options-container"></div>
                    </div>
                </div>
                <div class="navigation-buttons">
                    <button id="prevBtn" class="btn btn-secondary">
                        <svg class="icon"><use xlink:href="#icon-prev"></use></svg>
                        السابق
                    </button>
                    <button id="markReviewBtn" class="btn btn-secondary">
                        <svg class="icon" id="markReviewIcon"><use xlink:href="#icon-flag"></use></svg>
                        <span id="markReviewText">للمراجعة</span>
                    </button>
                    <button id="nextBtn" class="btn btn-secondary">
                        التالي
                        <svg class="icon"><use xlink:href="#icon-next"></use></svg>
                    </button>
                </div>
                <div id="resultContainer" class="result-container" style="display:none; margin-top: 2rem;">
                    <h2>🎉 تهانينا على إكمال الرحلة! 🎉</h2>
                    <p>البطل: <span id="resultUserName"></span></p>
                    <p>نتيجتك: <span id="score" class="score-emphasis">0</span>/<span id="totalQuestionsResult" class="score-emphasis">0</span></p>
                    <p>النسبة المئوية: <span id="percentage" class="score-emphasis">0</span>%</p>
                    <p style="display:none;" id="timeTakenParagraph">الوقت المستغرق: <span id="timeTaken"></span></p>
                    <div id="detailedReview" class="detailed-review"><h3>مراجعة تفصيلية لمغامرتك:</h3></div>
                    <button id="retakeExamBtn" class="btn btn-primary">
                        <svg class="icon"><use xlink:href="#icon-reset"></use></svg>
                        جولة أخرى؟
                    </button>
                </div>
                <button id="submitExamBtnMain" class="btn btn-danger btn-submit-main">
                     <svg class="icon"><use xlink:href="#icon-submit"></use></svg>
                    إنهاء وتسليم الإنجاز
                </button>
            </main>
        </div>
    </div>

    <div id="resultDisplayPage" class="page-container hidden-no-anim"> 
        <div class="exam-layout"> 
             <main class="main-content"> 
                <header class="exam-header" id="resultHeaderForLast" style="justify-content: center;"></header>
                <div id="resultContainerStandalone" class="result-container" style="display:block;"> 
                    <h2>🏆 سجل إنجازاتك 🏆</h2>
                    <p>البطل: <span id="resultUserNameStandalone"></span></p>
                    <p>النتيجة: <span id="scoreStandalone" class="score-emphasis">0</span>/<span id="totalQuestionsResultStandalone" class="score-emphasis">0</span></p>
                    <p>النسبة المئوية: <span id="percentageStandalone" class="score-emphasis">0</span>%</p>
                    <p style="display:none;" id="timeTakenStandaloneParagraph">الوقت المستغرق: <span id="timeTakenStandalone"></span></p>
                    <p>تاريخ الإنجاز: <span id="examDateStandalone"></span></p>
                    <div id="detailedReviewStandalone" class="detailed-review"><h3>تفاصيل رحلتك السابقة:</h3></div>
                    <button id="backToWelcomeBtn" class="btn btn-primary">
                        <svg class="icon"><use xlink:href="#icon-home"></use></svg>
                        العودة للقاعدة
                    </button>
                </div>
            </main>
        </div>
    </div>
    <footer style="width: 100%; text-align: center; padding: 1rem 0; color: var(--text-secondary); opacity: 0.7; font-size: clamp(0.8rem, 2vw, 0.95rem);">
        <p>© 2024 منصة الاختبارات الذكية - Made with 🔥 by Bebo Naiem</p>
    </footer>
</div> 

    <div id="customModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="btn">نعم</button>
                <button id="modalCancelBtn" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Question Data (Same as before, with hints) ---
             const allQuestions = [
                { id: 1, text: "ما هي عاصمة المملكة العربية السعودية؟", options: ["جدة", "الرياض", "الدمام", "مكة المكرمة"], correctAnswer: 1, image: null, explanation: "الرياض هي العاصمة السياسية والإدارية للمملكة العربية السعودية.", hint: "تقع في وسط البلاد وهي مدينة حديثة ومركز مالي هام." },
                { id: 2, text: "كم عدد ألوان قوس قزح الرئيسية؟", options: ["خمسة", "ستة", "سبعة", "ثمانية"], correctAnswer: 2, image: null, explanation: "يتكون قوس قزح من سبعة ألوان رئيسية وهي: الأحمر، البرتقالي، الأصفر، الأخضر، الأزرق، النيلي، والبنفسجي.", hint: "عدد فردي بين 5 و 9." },
                { id: 3, text: "أي من هذه الحيوانات يعتبر من الثدييات البحرية؟", options: ["التمساح", "النسر", "الدلفين", "سمك القرش الذهبي"], correctAnswer: 2, image: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Tursiops_truncatus_01.jpg/400px-Tursiops_truncatus_01.jpg", explanation: "الدلافين من الثدييات التي تتنفس الهواء وتلد صغارها حية وترضعهم.", hint: "حيوان ذكي وصديق للإنسان يعيش في الماء." },
                { id: 4, text: "ما هو أكبر كوكب في المجموعة الشمسية؟", options: ["الأرض", "المريخ", "المشترى", "زحل"], correctAnswer: 2, image: null, explanation: "كوكب المشترى هو الأضخم حجماً وكتلة بين كواكب المجموعة الشمسية.", hint: "يتميز ببقعة حمراء عملاقة." },
                { id: 5, text: "في أي قارة تقع جمهورية مصر العربية؟", options: ["آسيا", "أوروبا", "أفريقيا", "أمريكا الجنوبية"], correctAnswer: 2, image: null, explanation: "تقع مصر في الركن الشمالي الشرقي من قارة أفريقيا، ولها امتداد آسيوي في شبه جزيرة سيناء.", hint: "القارة التي ينبع منها نهر النيل." },
                { id: 6, text: "ما هو الرمز الكيميائي للماء؟", options: ["HO2", "H2O", "CO2", "NaCl"], correctAnswer: 1, image: null, explanation: "يتكون جزيء الماء من ذرتي هيدروجين وذرة أكسجين، لذا فرمزه H₂O.", hint: "يتكون من عنصرين أساسيين للحياة." },
                { id: 7, text: "من هو مؤلف نظرية النسبية؟", options: ["إسحاق نيوتن", "ألبرت أينشتاين", "جاليليو جاليلي", "نيكولا تسلا"], correctAnswer: 1, image: null, explanation: "ألبرت أينشتاين هو الفيزيائي الشهير الذي وضع نظرية النسبية الخاصة والعامة.", hint: "صاحب المعادلة الشهيرة E=mc²." },
                { id: 8, text: "في أي عام بدأت الحرب العالمية الأولى؟", options: ["1914", "1918", "1939", "1945"], correctAnswer: 0, image: null, explanation: "اندلعت الحرب العالمية الأولى في 28 يوليو 1914.", hint: "قبل الحرب العالمية الثانية بحوالي 25 عامًا." },
                { id: 9, text: "من هو أول الخلفاء الراشدين؟", options: ["عمر بن الخطاب", "عثمان بن عفان", "علي بن أبي طالب", "أبو بكر الصديق"], correctAnswer: 3, image: null, explanation: "أبو بكر الصديق رضي الله عنه هو أول الخلفاء الراشدين بعد وفاة النبي محمد صلى الله عليه وسلم.", hint: "صاحب النبي في الغار." },
                { id: 10, text: "ما هو أقرب نجم إلى الأرض (بعد الشمس)؟", options: ["سيروس", "رجل القنطور", "النسر الواقع", "الشعرى اليمانية"], correctAnswer: 1, image: null, explanation: "نجم رجل القنطور (بروكسيما سنتوري) هو أقرب النجوم إلينا بعد الشمس، ويبعد حوالي 4.24 سنة ضوئية.", hint: "اسمه اللاتيني يعني \"الأقرب\"." },
                { id: 11, text: "كم عدد القارات في العالم؟", options: ["5", "6", "7", "8"], correctAnswer: 2, image: null, explanation: "يوجد سبع قارات رئيسية في العالم.", hint: "أكثر من عدد أصابع اليد الواحدة بقليل." },
                { id: 12, text: "ما هو أطول نهر في العالم؟", options: ["الأمازون", "النيل", "اليانغتسي", "المسيسيبي"], correctAnswer: 1, image: null, explanation: "يعتبر نهر النيل أطول نهر في العالم، يليه نهر الأمازون.", hint: "يرتبط بحضارة قديمة في أفريقيا." },
                { id: 13, text: "ما هو الغاز الذي تتنفسه النباتات بشكل أساسي لعملية البناء الضوئي؟", options: ["الأكسجين", "النيتروجين", "ثاني أكسيد الكربون", "الهيدروجين"], correctAnswer: 2, image: null, explanation: "النباتات تمتص ثاني أكسيد الكربون من الجو لإنتاج الغذاء خلال عملية البناء الضوئي.", hint: "نحن نخرجه عند التنفس." },
                { id: 14, text: "ما هي عملة اليابان؟", options: ["اليورو", "الدولار", "الين", "الروبل"], correctAnswer: 2, image: null, explanation: "الين الياباني هو العملة الرسمية لليابان.", hint: "يبدأ بحرف الياء." },
                { id: 15, text: "من رسم لوحة الموناليزا؟", options: ["فان جوخ", "بيكاسو", "ليوناردو دا فينشي", "مايكل أنجلو"], correctAnswer: 2, image: null, explanation: "ليوناردو دا فينشي هو الفنان الإيطالي الشهير الذي رسم لوحة الموناليزا.", hint: "فنان وعبقري من عصر النهضة." },
                { id: 16, text: "ما هو أسرع حيوان بري؟", options: ["الأسد", "النمر", "الفهد", "الغزال"], correctAnswer: 2, image: null, explanation: "الفهد يعتبر أسرع حيوان بري، حيث يمكن أن تصل سرعته إلى حوالي 112 كم/ساعة.", hint: "يتميز بنقاطه السوداء." },
                { id: 17, text: "كم ضلعًا يوجد في جسم الإنسان البالغ عادةً؟", options: ["20", "22", "24", "26"], correctAnswer: 2, image: null, explanation: "يحتوي القفص الصدري للإنسان على 24 ضلعًا (12 زوجًا).", hint: "ضعف عدد أشهر السنة." },
                { id: 18, text: "ما هي أكبر صحراء في العالم؟", options: ["الصحراء الكبرى", "الصحراء العربية", "صحراء جوبي", "الصحراء القطبية الجنوبية (أنتاركتيكا)"], correctAnswer: 3, image: null, explanation: "الصحراء القطبية الجنوبية (أنتاركتيكا) هي أكبر صحراء في العالم من حيث المساحة، تليها الصحراء القطبية الشمالية، ثم الصحراء الكبرى.", hint: "ليست بالضرورة حارة، بل جافة." },
                { id: 19, text: "ما هو الكوكب المعروف بالكوكب الأحمر؟", options: ["الزهرة", "المريخ", "عطارد", "نبتون"], correctAnswer: 1, image: null, explanation: "يُعرف كوكب المريخ بالكوكب الأحمر بسبب وجود أكسيد الحديد (الصدأ) على سطحه.", hint: "سمي على اسم إله الحرب الروماني." },
                { id: 20, text: "ما هو عدد أيام السنة الكبيسة؟", options: ["364", "365", "366", "367"], correctAnswer: 2, image: null, explanation: "السنة الكبيسة تحتوي على 366 يومًا، حيث يضاف يوم إلى شهر فبراير.", hint: "يوم إضافي كل أربع سنوات تقريبًا." },
                { id: 21, text: "ما هو البحر الذي يفصل بين أوروبا وأفريقيا؟", options: ["البحر الأحمر", "البحر الكاريبي", "البحر الأبيض المتوسط", "بحر العرب"], correctAnswer: 2, image: null, explanation: "البحر الأبيض المتوسط هو الذي يفصل بين جنوب أوروبا وشمال أفريقيا.", hint: "اسمه يشير إلى توسطه بين الأراضي." },
                { id: 22, text: "كم قلبًا يمتلك الأخطبوط؟", options: ["1", "2", "3", "4"], correctAnswer: 2, image: null, explanation: "يمتلك الأخطبوط ثلاثة قلوب؛ اثنان يضخان الدم عبر الخياشيم، والثالث يضخ الدم إلى بقية الجسم.", hint: "أكثر من قلب واحد وأقل من أربعة." },
                { id: 23, text: "ما هو أصل رياضة الجودو؟", options: ["الصين", "كوريا", "اليابان", "تايلاند"], correctAnswer: 2, image: null, explanation: "الجودو هي رياضة قتالية يابانية حديثة، أسسها جيغورو كانو في أواخر القرن التاسع عشر.", hint: "بلد الشمس المشرقة." },
                { id: 24, text: "في أي دولة تقع مدينة البتراء الأثرية؟", options: ["مصر", "الأردن", "لبنان", "سوريا"], correctAnswer: 1, image: null, explanation: "تقع مدينة البتراء، المعروفة بمدائن صالح، في جنوب الأردن.", hint: "دولة مجاورة لفلسطين." },
                { id: 25, text: "ما هو الغاز الأكثر وفرة في الغلاف الجوي للأرض؟", options: ["الأكسجين", "النيتروجين", "الأرجون", "ثاني أكسيد الكربون"], correctAnswer: 1, image: null, explanation: "يشكل النيتروجين حوالي 78% من الغلاف الجوي للأرض.", hint: "رمزه N." },
                { id: 26, text: "من هو مخترع التليفون؟", options: ["توماس إديسون", "ألكسندر غراهام بيل", "نيكولا تسلا", "غولييلمو ماركوني"], correctAnswer: 1, image: null, explanation: "يُنسب الفضل إلى ألكسندر غراهام بيل في اختراع أول هاتف عملي.", hint: "اسمه مرتبط بالصوت والجرس." },
                { id: 27, text: "كم عدد الحروف في الأبجدية العربية؟", options: ["26", "28", "29", "30"], correctAnswer: 1, image: null, explanation: "تتكون الأبجدية العربية من 28 حرفًا أساسيًا.", hint: "أقل من 30 بقليل." },
                { id: 28, text: "ما هو أعلى جبل في العالم؟", options: ["جبل كليمنجارو", "جبل إفرست", "جبل كي 2", "جبل مون بلان"], correctAnswer: 1, image: null, explanation: "جبل إفرست، الواقع في سلسلة جبال الهيمالايا، هو أعلى قمة جبلية على وجه الأرض.", hint: "يقع في نيبال." },
                { id: 29, text: "ما هي وحدة قياس القوة في النظام الدولي للوحدات؟", options: ["الواط", "الجول", "النيوتن", "الباسكال"], correctAnswer: 2, image: null, explanation: "النيوتن (N) هي وحدة قياس القوة.", hint: "على اسم عالم فيزياء شهير." },
                { id: 30, text: "من كتب مسرحية \"روميو وجولييت\"؟", options: ["تشارلز ديكنز", "جورج برنارد شو", "ويليام شكسبير", "أوسكار وايلد"], correctAnswer: 2, image: null, explanation: "مسرحية \"روميو وجولييت\" هي إحدى أشهر أعمال الكاتب الإنجليزي ويليام شكسبير.", hint: "أشهر كاتب مسرحي إنجليزي." },
                { id: 31, text: "ما هو لون صندوق الطائرة الأسود؟", options: ["أسود", "برتقالي", "أحمر", "أصفر"], correctAnswer: 1, image: null, explanation: "على الرغم من اسمه، فإن \"الصندوق الأسود\" للطائرة (مسجل بيانات الرحلة ومسجل الصوت في قمرة القيادة) عادة ما يكون لونه برتقاليًا أو أصفرًا فاتحًا ليسهل العثور عليه بعد الحوادث.", hint: "لون فاكهة حمضية." },
                { id: 32, text: "ما هي الدولة التي لديها أكبر عدد من السكان في العالم؟", options: ["الهند", "الولايات المتحدة", "إندونيسيا", "الصين"], correctAnswer: 0, image: null, explanation: "اعتبارًا من عام 2023، تجاوزت الهند الصين لتصبح الدولة الأكثر اكتظاظًا بالسكان في العالم.", hint: "دولة آسيوية تشتهر بالبهارات." },
                { id: 33, text: "ما هو أسرع شيء في الكون؟", options: ["الصوت", "الضوء", "الفهد", "مركبة فضائية"], correctAnswer: 1, image: null, explanation: "سرعة الضوء في الفراغ هي أقصى سرعة يمكن أن تنتقل بها أي طاقة أو مادة أو معلومات في الكون.", hint: "نراه قبل أن نسمع الرعد." },
                { id: 34, text: "كم عدد اللاعبين في فريق كرة القدم؟", options: ["9", "10", "11", "12"], correctAnswer: 2, image: null, explanation: "يتكون فريق كرة القدم من 11 لاعبًا على أرض الملعب.", hint: "أحد عشر." },
                { id: 35, text: "ما هو الحيوان الوطني لأستراليا؟", options: ["الكوالا", "الكنغر الأحمر", "الإيمو", "خلد الماء"], correctAnswer: 1, image: null, explanation: "الكنغر الأحمر هو الحيوان الوطني لأستراليا ويظهر على شعار النبالة الأسترالي.", hint: "يقفز ولديه جيب." },
                { id: 36, text: "ما هو المعدن السائل الوحيد في درجة حرارة الغرفة العادية؟", options: ["الذهب", "الفضة", "الزئبق", "النحاس"], correctAnswer: 2, image: null, explanation: "الزئبق هو المعدن الوحيد الذي يكون سائلاً في درجة حرارة الغرفة القياسية.", hint: "يستخدم في موازين الحرارة القديمة." },
                { id: 37, text: "ما هي عاصمة كندا؟", options: ["تورونتو", "مونتريال", "فانكوفر", "أوتاوا"], correctAnswer: 3, image: null, explanation: "أوتاوا هي عاصمة كندا.", hint: "ليست أكبر مدنها شهرة." },
                { id: 38, text: "ما هو لون الدم المؤكسج (الغني بالأكسجين)؟", options: ["أزرق فاتح", "أحمر فاتح", "أحمر داكن", "أخضر"], correctAnswer: 1, image: null, explanation: "الدم الغني بالأكسجين يكون لونه أحمر فاتحًا، بينما الدم الفقير بالأكسجين يكون أحمر داكنًا (وليس أزرق كما يعتقد البعض).", hint: "لون التفاح الأحمر." },
                { id: 39, text: "ما هي أكبر جزيرة في العالم؟", options: ["بورنيو", "مدغشقر", "جرينلاند", "غينيا الجديدة"], correctAnswer: 2, image: null, explanation: "جرينلاند هي أكبر جزيرة في العالم من حيث المساحة.", hint: "اسمها يعني \"الأرض الخضراء\" بشكل مفارق." },
                { id: 40, text: "كم عدد فقرات العمود الفقري لدى الإنسان البالغ؟", options: ["26", "30", "33", "24"], correctAnswer: 0, image: null, explanation: "يتكون العمود الفقري للإنسان البالغ عادةً من 26 فقرة (بعد التحام بعض الفقرات العجزية والعصعصية التي تكون 33 في الطفولة).", hint: "عدد زوجي أقل من 30." },
                { id: 41, text: "ما هو اسم أطول سلسلة جبال في العالم؟", options: ["جبال الأنديز", "جبال الهيمالايا", "جبال روكي", "جبال الأورال"], correctAnswer: 0, image: null, explanation: "جبال الأنديز في أمريكا الجنوبية هي أطول سلسلة جبال قارية في العالم.", hint: "تقع في أمريكا الجنوبية." },
                { id: 42, text: "في أي رياضة يستخدم مصطلح \"ضربة جزاء\"؟", options: ["كرة السلة", "كرة الطائرة", "كرة القدم", "التنس"], correctAnswer: 2, image: null, explanation: "ضربة الجزاء هي عقوبة شائعة في رياضة كرة القدم.", hint: "الرياضة الأكثر شعبية في العالم." },
                { id: 43, text: "ما هو الحيوان الذي ينام واقفًا؟", options: ["القطة", "الكلب", "الحصان", "الأرنب"], correctAnswer: 2, image: null, explanation: "يمكن للخيول أن تنام واقفة بفضل نظام خاص من الأربطة والأوتار في أرجلها يسمح لها بتثبيت مفاصلها.", hint: "يركبه الفرسان." },
                { id: 44, text: "ما هي أكبر محيطات العالم؟", options: ["المحيط الأطلسي", "المحيط الهندي", "المحيط الهادئ", "المحيط المتجمد الشمالي"], correctAnswer: 2, image: null, explanation: "المحيط الهادئ هو أكبر وأعمق محيطات العالم.", hint: "اسمه يعني السلام والهدوء." },
                { id: 45, text: "ما هو الكوكب الذي لديه أكبر عدد من الأقمار الطبيعية المعروفة في نظامنا الشمسي؟", options: ["المشترى", "زحل", "أورانوس", "نبتون"], correctAnswer: 1, image: null, explanation: "اعتبارًا من الاكتشافات الحديثة، يتنافس زحل والمشترى على لقب الكوكب ذي العدد الأكبر من الأقمار، ولكن زحل حاليًا لديه عدد أكبر من الأقمار المؤكدة.", hint: "يتميز بحلقاته الشهيرة." },
                { id: 46, text: "ما هو الاسم العلمي لملح الطعام؟", options: ["كلوريد البوتاسيوم", "كبريتات المغنيسيوم", "كلوريد الصوديوم", "بيكربونات الصوديوم"], correctAnswer: 2, image: null, explanation: "ملح الطعام الشائع هو مركب كيميائي يُعرف باسم كلوريد الصوديوم (NaCl).", hint: "NaCl." },
                { id: 47, text: "من هو الإله الرئيسي في الأساطير اليونانية القديمة؟", options: ["أبولو", "بوسيدون", "زيوس", "هاديس"], correctAnswer: 2, image: null, explanation: "زيوس هو ملك الآلهة وإله السماء والرعد في الميثولوجيا الإغريقية.", hint: "يحمل صاعقة." },
                { id: 48, text: "ما هي الدولة التي تشتهر بساعة بيغ بن؟", options: ["فرنسا", "ألمانيا", "إيطاليا", "المملكة المتحدة"], correctAnswer: 3, image: null, explanation: "ساعة بيغ بن (رسميًا برج إليزابيث) هي معلم شهير في لندن، عاصمة المملكة المتحدة.", hint: "بلد الشاي والملكة." },
                { id: 49, text: "ما هو العضو الرئيسي في الجهاز التنفسي للإنسان؟", options: ["القلب", "الكبد", "الرئتان", "الكليتان"], correctAnswer: 2, image: null, explanation: "الرئتان هما العضوان الأساسيان المسؤولان عن تبادل الغازات في عملية التنفس.", hint: "نستخدمهما للتنفس." },
                { id: 50, text: "ما هو أصل البيتزا الحديثة؟", options: ["الولايات المتحدة", "فرنسا", "إيطاليا", "اليونان"], correctAnswer: 2, image: null, explanation: "تعتبر مدينة نابولي في إيطاليا مهد البيتزا الحديثة.", hint: "دولة تشتهر بالمعكرونة." }
            ];
            let currentExamQuestions = []; 
            const TIME_PER_QUESTION = 30; 

            const welcomePageEl = document.getElementById('welcomePage');
            const examPageEl = document.getElementById('examPage');
            const startExamBtn = document.getElementById('startExamBtn');
            const userNameInputEl = document.getElementById('userNameInput');
            const nameInputSectionEl = document.getElementById('nameInputSection'); 
            const welcomeBackMessageEl = document.getElementById('welcomeBackMessage'); 
            const numQuestionsSelectEl = document.getElementById('numQuestionsSelect');
            const quizContainer = document.getElementById('quizContainer');
            const resultContainerEl = document.getElementById('resultContainer'); 
            const questionTitleEl = document.getElementById('questionTitle');
            const questionTextEl = document.getElementById('questionText');
            const questionImageContainerEl = document.getElementById('questionImageContainer');
            const questionImageEl = document.getElementById('questionImage');
            const optionsContainerEl = document.getElementById('optionsContainer');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            const markReviewIconEl = document.getElementById('markReviewIcon');
            const markReviewTextEl = document.getElementById('markReviewText');
            const submitExamBtnMain = document.getElementById('submitExamBtnMain');
            const submitExamBtnSidebar = document.getElementById('submitExamBtnSidebar');
            const questionTimerDisplayEl = document.getElementById('questionTimerDisplay'); 
            const questionTimerContainerEl = document.getElementById('questionTimerContainer'); 
            const progressBarFillEl = document.getElementById('progressBarFill');
            const progressTextEl = document.getElementById('progressText');
            const questionNavigatorEl = document.getElementById('questionNavigator');
            const examUserNameDisplayEl = document.getElementById('examUserNameDisplay');
            const retakeExamBtn = document.getElementById('retakeExamBtn'); 
            const showLastResultBtn = document.getElementById('showLastResultBtn');
            const resultDisplayPageEl = document.getElementById('resultDisplayPage');
            const resultHeaderForLastEl = document.getElementById('resultHeaderForLast');
            const resultUserNameStandaloneEl = document.getElementById('resultUserNameStandalone');
            const scoreStandaloneEl = document.getElementById('scoreStandalone');
            const totalQuestionsResultStandaloneEl = document.getElementById('totalQuestionsResultStandalone');
            const percentageStandaloneEl = document.getElementById('percentageStandalone');
            const timeTakenStandaloneParagraph = document.getElementById('timeTakenStandaloneParagraph'); // Get the paragraph
            const examDateStandaloneEl = document.getElementById('examDateStandalone');
            const detailedReviewStandaloneEl = document.getElementById('detailedReviewStandalone');
            const backToWelcomeBtn = document.getElementById('backToWelcomeBtn');
            const hintBtn = document.getElementById('hintBtn');
            const hintTextEl = document.getElementById('hintText');
            const resetExamBtn = document.getElementById('resetExamBtn');
            const correctSound = document.getElementById('correctSound');
            const incorrectSound = document.getElementById('incorrectSound');
            const clickSound = document.getElementById('clickSound');
            const examStartSound = document.getElementById('examStartSound');
            const examEndSound = document.getElementById('examEndSound');
            const hintSound = document.getElementById('hintSound');
            const timeUpSound = clickSound; 
            const muteBtn = document.getElementById('muteBtn');
            const muteIconEl = document.getElementById('muteIcon');
            let isMuted = localStorage.getItem('examIsMuted_v6') === 'true'; 
            const customModalEl = document.getElementById('customModal');
            const modalMessageEl = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            let modalConfirmCallback = null;
            
            let currentQuestionIndex = 0;
            let userAnswers = [];
            let markedForReview = [];
            let score = 0;
            let questionTimeLeft = TIME_PER_QUESTION;
            let questionTimerInterval;
            let userName = "زائر"; 

            function playSound(soundElement) { /* ... (Same as before) ... */ if (!isMuted && soundElement) { soundElement.currentTime = 0; soundElement.play().catch(e => console.warn("Audio play failed:", e)); } }
            muteBtn.addEventListener('click', () => { /* ... (Same as before) ... */ isMuted = !isMuted; muteIconEl.innerHTML = `<use xlink:href="${isMuted ? '#icon-sound-on' : '#icon-sound-off'}"></use>`; localStorage.setItem('examIsMuted_v6', isMuted); if (!isMuted) playSound(clickSound); });
            muteIconEl.innerHTML = `<use xlink:href="${isMuted ? '#icon-sound-on' : '#icon-sound-off'}"></use>`;
            function showCustomModal(message, confirmCallback, showCancel = true) { /* ... (Same as before) ... */ playSound(clickSound); modalMessageEl.innerHTML = message; modalConfirmCallback = confirmCallback; customModalEl.style.display = 'flex'; modalCancelBtn.style.display = showCancel ? 'inline-flex' : 'none'; modalConfirmBtn.focus(); customModalEl.querySelector('.modal-content').style.margin = 'auto'; const focusableElements = 'button'; const firstFocusableElement = modalConfirmBtn; const focusableContent = Array.from(customModalEl.querySelectorAll(focusableElements)).filter(el => el.style.display !== 'none'); const lastFocusableElement = focusableContent[focusableContent.length - 1] || firstFocusableElement; document.addEventListener('keydown', trapTabKeyInModal); function trapTabKeyInModal(e) { let isTabPressed = e.key === 'Tab' || e.keyCode === 9; if (!isTabPressed) return; if (e.shiftKey) { if (document.activeElement === firstFocusableElement && showCancel) { lastFocusableElement.focus(); e.preventDefault(); } else if (document.activeElement === firstFocusableElement && !showCancel) { e.preventDefault(); } } else { if (document.activeElement === lastFocusableElement && showCancel) { firstFocusableElement.focus(); e.preventDefault(); } else if (document.activeElement === lastFocusableElement && !showCancel) { e.preventDefault(); } } } customModalEl.addEventListener('hideModal', () => { document.removeEventListener('keydown', trapTabKeyInModal); }, {once: true}); }
            function hideCustomModal() { /* ... (Same as before) ... */ customModalEl.style.animation = 'modalClose 0.3s ease-out forwards'; setTimeout(() => { customModalEl.style.display = 'none'; customModalEl.style.animation = ''; modalConfirmCallback = null; const hideEvent = new Event('hideModal'); customModalEl.dispatchEvent(hideEvent); }, 300); }
            modalConfirmBtn.addEventListener('click', () => { playSound(clickSound); if (modalConfirmCallback) { modalConfirmCallback(); } hideCustomModal(); });
            modalCancelBtn.addEventListener('click', () => { playSound(clickSound); hideCustomModal(); });
            window.addEventListener('click', (event) => { if (event.target == customModalEl) { hideCustomModal(); } });
            document.addEventListener('keydown', (e) => { if (e.key === "Escape" && customModalEl.style.display === 'flex') { hideCustomModal(); } });
            const styleSheetForModalClose = document.createElement("style"); styleSheetForModalClose.type = "text/css"; styleSheetForModalClose.innerText = `@keyframes modalClose { from { opacity: 1; transform: scale(1) translateY(0); } to { opacity: 0; transform: scale(0.8) translateY(20px); } }`; document.head.appendChild(styleSheetForModalClose);
            function switchPage(pageToShow, pagesToHide) { /* ... (Same as before) ... */ playSound(clickSound); if (!Array.isArray(pagesToHide)) { pagesToHide = [pagesToHide]; } pagesToHide.forEach(pageToHide => { if (pageToHide && pageToHide.style.display !== 'none') { pageToHide.classList.add('hidden-anim'); setTimeout(() => { pageToHide.style.display = 'none'; pageToHide.classList.remove('hidden-anim'); }, 400); } }); if (pageToShow.style.display === 'block' && !pageToShow.classList.contains('hidden-anim')) { return; } setTimeout(() => { pageToShow.style.display = 'block'; pageToShow.style.opacity = '0'; pageToShow.style.transform = 'translateY(30px) scale(0.98)'; void pageToShow.offsetWidth; pageToShow.style.animation = 'fadeInGrow 0.6s var(--transition-cubic) forwards'; pageToShow.onanimationend = () => { pageToShow.style.animation = ''; pageToShow.onanimationend = null; }; }, pagesToHide.some(p => p && p.style.display !== 'none') ? 100 : 0); }

            function showWelcomePage() {
                switchPage(welcomePageEl, [examPageEl, resultDisplayPageEl]);
                quizContainer.style.display = 'block';
                document.querySelector('#examPage .navigation-buttons').style.display = 'flex';
                submitExamBtnMain.style.display = 'block';
                submitExamBtnSidebar.style.display = 'block'; 
                questionTimerContainerEl.style.display = 'none'; 
                document.querySelector('#examPage .exam-header .progress-container').style.display = 'block';
                resultContainerEl.style.display = 'none'; 
                const sidebar = document.querySelector('#examPage .sidebar'); 
                if (sidebar) sidebar.style.opacity = '1';
                resetExamBtn.style.display = 'inline-flex'; 

                const storedName = localStorage.getItem('examSystemUserName_v6');
                if (storedName) { userName = storedName; nameInputSectionEl.style.display = 'none'; welcomeBackMessageEl.textContent = `مرحباً بعودتك يا ${userName}! جاهز لجولة أخرى؟`; welcomeBackMessageEl.style.display = 'block';
                } else { nameInputSectionEl.style.display = 'block'; welcomeBackMessageEl.style.display = 'none'; userNameInputEl.value = ''; userNameInputEl.focus(); }

                const lastResult = localStorage.getItem('examLastResult_v6');
                if (lastResult) { showLastResultBtn.style.display = 'inline-flex'; } else { showLastResultBtn.style.display = 'none'; }
                
                const allOption = numQuestionsSelectEl.querySelector('option[value="all"]');
                if (allOption) allOption.textContent = `كل التحديات (${allQuestions.length})`;

                numQuestionsSelectEl.querySelectorAll('option').forEach(opt => {
                    const val = parseInt(opt.value);
                    const originalText = opt.getAttribute('data-original-text') || opt.textContent.split(' (')[0];
                    opt.setAttribute('data-original-text', originalText); 
                    if (!isNaN(val) && val > allQuestions.length) { opt.disabled = true; opt.textContent = `${originalText} (غير متوفر - ${allQuestions.length} فقط)`;
                    } else { opt.disabled = false; opt.textContent = originalText; }
                });
                if (allQuestions.length < 10) { numQuestionsSelectEl.value = "all";
                } else { if (numQuestionsSelectEl.options[numQuestionsSelectEl.selectedIndex].disabled) { numQuestionsSelectEl.value = "all"; } }
            }
            function showExamPageUI() { switchPage(examPageEl, [welcomePageEl, resultDisplayPageEl]); initExam(); playSound(examStartSound); }
            function showResultDisplayPageUI() { switchPage(resultDisplayPageEl, [welcomePageEl, examPageEl]); }

            startExamBtn.addEventListener('click', () => { /* ... (Same logic for starting exam) ... */
                const storedName = localStorage.getItem('examSystemUserName_v6');
                if (!storedName) { 
                    const currentNameInput = userNameInputEl.value.trim();
                    if (currentNameInput === "") { showCustomModal("الرجاء إدخال اسمك للمتابعة في هذه الرحلة المثيرة!", () => { userNameInputEl.focus(); }); return; }
                    userName = currentNameInput; localStorage.setItem('examSystemUserName_v6', userName); 
                    nameInputSectionEl.style.display = 'none'; welcomeBackMessageEl.textContent = `أهلاً بك يا ${userName}! فلنبدأ الاختبار.`; welcomeBackMessageEl.style.display = 'block';
                }
                let numQValue = numQuestionsSelectEl.value; let questionsToUse = [...allQuestions]; 
                for (let i = questionsToUse.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [questionsToUse[i], questionsToUse[j]] = [questionsToUse[j], questionsToUse[i]]; }
                if (numQValue !== "all") { let numQ = parseInt(numQValue); if (!isNaN(numQ) && numQ > 0) { currentExamQuestions = questionsToUse.slice(0, Math.min(numQ, questionsToUse.length)); } else { currentExamQuestions = questionsToUse; }
                } else { currentExamQuestions = questionsToUse; }
                if (currentExamQuestions.length === 0) { showCustomModal("لا توجد أسئلة متاحة للاختيار المحدد. الرجاء تعديل اختيارك.", () => {}); return; }
                showExamPageUI();
            });
            
            retakeExamBtn.addEventListener('click', () => switchPage(welcomePageEl, [examPageEl])); 
            backToWelcomeBtn.addEventListener('click', () => switchPage(welcomePageEl, [resultDisplayPageEl])); 
            showLastResultBtn.addEventListener('click', () => { /* ... (Same) ... */ const lastResultData = localStorage.getItem('examLastResult_v6'); if (lastResultData) { const resultData = JSON.parse(lastResultData); displayStoredResult(resultData); showResultDisplayPageUI(); } else { showCustomModal("لا توجد نتيجة سابقة محفوظة.", () => {}, false); } });
            resetExamBtn.addEventListener('click', () => { /* ... (Same) ... */ showCustomModal("هل أنت متأكد أنك تريد إعادة الاختبار؟ <br>سيتم فقدان تقدمك الحالي.", () => { playSound(examStartSound); initExam(); }); });

            function startQuestionTimer() {
                if (questionTimerInterval) clearInterval(questionTimerInterval);
                questionTimeLeft = TIME_PER_QUESTION;
                updateQuestionTimerDisplay();
                questionTimerContainerEl.classList.remove('danger-time');
                questionTimerContainerEl.style.display = 'block'; 

                questionTimerInterval = setInterval(() => {
                    questionTimeLeft--;
                    updateQuestionTimerDisplay();
                    if (questionTimeLeft <= 0) {
                        clearInterval(questionTimerInterval);
                        playSound(timeUpSound); 
                        userAnswers[currentQuestionIndex] = null; 
                        updateQuestionNavigatorStatus(); 
                        updateProgress();
                        if (currentQuestionIndex < currentExamQuestions.length - 1) {
                            nextQuestion();
                        } else {
                            showCustomModal("انتهى وقت السؤال الأخير! سيتم الآن تسليم إجاباتك.", submitExam, false);
                        }
                    }
                }, 1000);
            }
            function updateQuestionTimerDisplay() {
                questionTimerDisplayEl.textContent = questionTimeLeft;
                if (questionTimeLeft <= 5 && questionTimeLeft > 0 && !questionTimerContainerEl.classList.contains('danger-time')) {
                    questionTimerContainerEl.classList.add('danger-time');
                } else if (questionTimeLeft <= 0 && !questionTimerContainerEl.classList.contains('danger-time')) {
                    questionTimerContainerEl.classList.add('danger-time');
                } else if (questionTimeLeft > 5 && questionTimerContainerEl.classList.contains('danger-time')) {
                     questionTimerContainerEl.classList.remove('danger-time');
                }
            }
            function stopQuestionTimer() { clearInterval(questionTimerInterval); }

            function initExam() {
                currentQuestionIndex = 0;
                userAnswers = new Array(currentExamQuestions.length).fill(null);
                markedForReview = new Array(currentExamQuestions.length).fill(false);
                score = 0;
                examUserNameDisplayEl.textContent = userName; 
                quizContainer.style.display = 'block'; 
                resultContainerEl.style.display = 'none'; 
                document.querySelector('#examPage .navigation-buttons').style.display = 'flex'; 
                submitExamBtnMain.style.display = 'block'; 
                submitExamBtnSidebar.style.display = 'block'; 
                questionTimerContainerEl.style.display = 'block'; 
                document.querySelector('#examPage .exam-header .progress-container').style.display = 'block'; 
                const sidebar = document.querySelector('#examPage .sidebar');
                if (sidebar) sidebar.style.opacity = '1';
                hintTextEl.style.display = 'none'; 
                hintBtn.disabled = false; 
                resetExamBtn.style.display = 'inline-flex'; 
                loadQuestion(currentQuestionIndex);
                renderQuestionNavigator();
                updateProgress();
                updateMarkReviewButton(); 
            }

            function loadQuestion(index) {
                stopQuestionTimer(); 
                quizContainer.classList.add('loading-next');
                hintTextEl.style.display = 'none'; 
                hintBtn.disabled = false; 
                setTimeout(() => {
                    const question = currentExamQuestions[index]; 
                    questionTitleEl.textContent = `تحدي ${index + 1} / ${currentExamQuestions.length}`;
                    questionTextEl.textContent = question.text;
                    if (question.image) { questionImageEl.src = question.image; questionImageContainerEl.style.display = 'block'; } 
                    else { questionImageContainerEl.style.display = 'none'; }
                    hintBtn.style.display = question.hint ? 'inline-flex' : 'none';
                    optionsContainerEl.innerHTML = '';
                    question.options.forEach((option, i) => { 
                        const optionId = `q${index}_option${i}`; const optionEl = document.createElement('label'); optionEl.classList.add('option'); optionEl.htmlFor = optionId;
                        const radioBtn = document.createElement('input'); radioBtn.type = 'radio'; radioBtn.name = `question${index}`; radioBtn.id = optionId; radioBtn.value = i;
                        if (userAnswers[index] === i) { radioBtn.checked = true; optionEl.classList.add('selected'); }
                        radioBtn.addEventListener('change', () => { selectAnswer(index, i); playSound(clickSound); });
                        optionEl.appendChild(radioBtn); optionEl.appendChild(document.createTextNode(` ${option}`)); optionsContainerEl.appendChild(optionEl);
                    });
                    updateNavigationButtons(); updateMarkReviewButton(); updateQuestionNavigatorStatus(); 
                    quizContainer.classList.remove('loading-next'); quizContainer.scrollTop = 0; 
                    startQuestionTimer(); 
                }, 250); 
            }
            
            hintBtn.addEventListener('click', () => { /* ... (Same) ... */ playSound(hintSound); const question = currentExamQuestions[currentQuestionIndex]; if (question && question.hint) { hintTextEl.textContent = `💡 تلميح: ${question.hint}`; hintTextEl.style.display = 'block'; hintBtn.disabled = true; } });
            function selectAnswer(questionIndex, optionIndex) {  
                 userAnswers[questionIndex] = optionIndex;
                stopQuestionTimer(); 
                document.querySelectorAll(`#optionsContainer .option`).forEach(opt => opt.classList.remove('selected'));
                const selectedLabel = document.querySelector(`label[for="q${questionIndex}_option${optionIndex}"]`);
                if (selectedLabel) { selectedLabel.classList.add('selected'); }
                updateQuestionNavigatorStatus(); updateProgress();
            }
            function nextQuestion() { playSound(clickSound); if (currentQuestionIndex < currentExamQuestions.length - 1) { currentQuestionIndex++; loadQuestion(currentQuestionIndex); } else { confirmSubmit(); } }
            function prevQuestion() { playSound(clickSound); if (currentQuestionIndex > 0) { currentQuestionIndex--; loadQuestion(currentQuestionIndex); } }
            function jumpToQuestion(index) { playSound(clickSound); currentQuestionIndex = index; loadQuestion(currentQuestionIndex); }
            function updateNavigationButtons() { prevBtn.disabled = currentQuestionIndex === 0; nextBtn.disabled = currentQuestionIndex === currentExamQuestions.length - 1 && userAnswers[currentQuestionIndex] === null; }
            function toggleMarkReview() { /* ... (Same) ... */ playSound(clickSound); markedForReview[currentQuestionIndex] = !markedForReview[currentQuestionIndex]; updateMarkReviewButton(); updateQuestionNavigatorStatus(); }
            function updateMarkReviewButton() { /* ... (Same) ... */ const isMarked = markedForReview[currentQuestionIndex]; markReviewBtn.classList.toggle('marked-active', isMarked); markReviewIconEl.innerHTML = `<use xlink:href="${isMarked ? '#icon-unflag' : '#icon-flag'}"></use>`; markReviewTextEl.textContent = isMarked ? ' إلغاء التمييز' : ' للمراجعة';}
            function renderQuestionNavigator() { /* ... (Same) ... */ questionNavigatorEl.innerHTML = ''; currentExamQuestions.forEach((_, index) => { const navBtn = document.createElement('button'); navBtn.classList.add('btn', 'nav-btn'); navBtn.textContent = index + 1; navBtn.setAttribute('aria-label', `الانتقال للسؤال ${index + 1}`); navBtn.addEventListener('click', () => jumpToQuestion(index)); questionNavigatorEl.appendChild(navBtn); });}
            function updateQuestionNavigatorStatus() { /* ... (Same) ... */ const navButtons = questionNavigatorEl.querySelectorAll('.nav-btn'); navButtons.forEach((btn, index) => { btn.classList.remove('current', 'answered', 'marked'); if (index === currentQuestionIndex) btn.classList.add('current'); if (userAnswers[index] !== null) btn.classList.add('answered'); if (markedForReview[index]) btn.classList.add('marked'); });}
            function updateProgress() { /* ... (Same) ... */ const answeredQuestions = userAnswers.filter(answer => answer !== null).length; if (currentExamQuestions.length > 0) { const progressPercentage = (answeredQuestions / currentExamQuestions.length) * 100; progressBarFillEl.style.width = `${progressPercentage}%`; } else { progressBarFillEl.style.width = `0%`; } progressTextEl.textContent = `${answeredQuestions}/${currentExamQuestions.length}`; }
            function confirmSubmit() { stopQuestionTimer(); const unansweredCount = userAnswers.filter(a => a === null).length; let message = "هل أنت واثق من رغبتك في إنهاء وتسليم الاختبار الآن؟"; if (unansweredCount > 0) { message += `<br><br><strong style="color:var(--warning);">تنبيه:</strong> لديك ${unansweredCount} ${unansweredCount === 1 ? 'سؤال لم تتم الإجابة عليه' : (unansweredCount === 2 ? 'سؤالان لم تتم الإجابة عليهما' : `${unansweredCount} أسئلة لم تتم الإجابة عليها`)}.`; } showCustomModal(message, () => { playSound(examEndSound); submitExam(); });}
            
            function submitExam() { 
                stopQuestionTimer(); 
                score = 0;
                userAnswers.forEach((answer, index) => { if (currentExamQuestions[index] && answer === currentExamQuestions[index].correctAnswer) score++; });
                const examEndTime = new Date(); 
                const examDate = examEndTime.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const resultData = {
                    userName: userName, score: score, totalQuestions: currentExamQuestions.length,
                    percentage: currentExamQuestions.length > 0 ? ((score / currentExamQuestions.length) * 100).toFixed(1) : "0.0",
                    timeTaken: "N/A (مؤقت لكل سؤال)", 
                    examDate: examDate,
                    questions: currentExamQuestions.map(q => ({ text: q.text, options: q.options, correctAnswer: q.correctAnswer, explanation: q.explanation, hint: q.hint })), 
                    userAnswers: [...userAnswers] 
                };
                localStorage.setItem('examLastResult_v6', JSON.stringify(resultData));
                showLastResultBtn.style.display = 'inline-flex'; 
                displayCurrentExamResults(resultData); 
                resultContainerEl.style.display = 'block'; 
            }
            function displayCurrentExamResults(resultData) {  
                quizContainer.style.display = 'none';
                document.querySelector('#examPage .navigation-buttons').style.display = 'none';
                submitExamBtnMain.style.display = 'none';
                questionTimerContainerEl.style.display = 'none'; 
                document.querySelector('#examPage .exam-header .progress-container').style.display = 'none';
                resetExamBtn.style.display = 'none'; 
                hintBtn.style.display = 'none'; 
                const userGreetingEl = document.querySelector('#examPage .exam-header .user-greeting');
                if (userGreetingEl) { userGreetingEl.innerHTML = `مجهود رائع يا <span style="color: var(--accent-primary); font-weight: var(--font-weight-bold);">${resultData.userName}</span>! إليك نتيجتك:`; userGreetingEl.style.textAlign = 'center'; userGreetingEl.style.width = '100%'; userGreetingEl.style.fontSize = '1.5em'; userGreetingEl.style.marginBottom = '25px'; }
                document.getElementById('resultUserName').textContent = resultData.userName;
                document.getElementById('score').textContent = resultData.score;
                document.getElementById('totalQuestionsResult').textContent = resultData.totalQuestions;
                document.getElementById('percentage').textContent = resultData.percentage;
                document.getElementById('timeTakenParagraph').style.display = 'none'; 
                const detailedReviewEl = document.getElementById('detailedReview');
                populateDetailedReview(detailedReviewEl, resultData.questions, resultData.userAnswers);
                submitExamBtnSidebar.style.display = 'none';
                const sidebar = document.querySelector('#examPage .sidebar');
                if (sidebar) sidebar.style.opacity = '0.7';
                sidebar.scrollTop = 0; window.scrollTo(0,0);
            }
            function displayStoredResult(resultData) { 
                resultHeaderForLastEl.innerHTML = `<h2>🏆 سجل إنجازاتك بتاريخ: ${resultData.examDate}</h2>`;
                resultUserNameStandaloneEl.textContent = resultData.userName;
                scoreStandaloneEl.textContent = resultData.score;
                totalQuestionsResultStandaloneEl.textContent = resultData.totalQuestions;
                percentageStandaloneEl.textContent = resultData.percentage;
                timeTakenStandaloneParagraph.style.display = 'none';
                examDateStandaloneEl.textContent = resultData.examDate;
                populateDetailedReview(detailedReviewStandaloneEl, resultData.questions, resultData.userAnswers);
                window.scrollTo(0,0);
            }
            function populateDetailedReview(reviewContainer, questionsArray, userAnswersArray) { /* ... (Same as before) ... */ 
                reviewContainer.innerHTML = '<h3>تفاصيل رحلتك:</h3>'; 
                questionsArray.forEach((q, i) => {
                    const reviewItem = document.createElement('div'); reviewItem.classList.add('review-item');
                    const questionP = document.createElement('p'); questionP.classList.add('review-question'); questionP.innerHTML = `<strong>تحدي ${i + 1}:</strong> ${q.text}`; reviewItem.appendChild(questionP);
                    const optionsDiv = document.createElement('div'); optionsDiv.classList.add('review-options');
                    const userAnswerText = userAnswersArray[i] !== null && q.options[userAnswersArray[i]] !== undefined ? q.options[userAnswersArray[i]] : "لم تتم الإجابة";
                    const userAnswerP = document.createElement('p'); const isUserCorrect = userAnswersArray[i] === q.correctAnswer;
                    userAnswerP.innerHTML = `إجابتك: <span class="user-choice ${isUserCorrect ? 'correct' : (userAnswersArray[i] !== null ? 'incorrect' : '')}">${userAnswerText}</span>`;
                    if (userAnswersArray[i] !== null) { userAnswerP.innerHTML = `${isUserCorrect ? '✔' : '✘'} ` + userAnswerP.innerHTML; }
                    optionsDiv.appendChild(userAnswerP);
                    if (!isUserCorrect && userAnswersArray[i] !== null) { const correctAnswerP = document.createElement('p'); correctAnswerP.innerHTML = `✔ الإجابة الصحيحة: <span class="correct-choice">${q.options[q.correctAnswer]}</span>`; optionsDiv.appendChild(correctAnswerP); } 
                    else if (userAnswersArray[i] === null) { const correctAnswerP = document.createElement('p'); correctAnswerP.innerHTML = `✔ الإجابة الصحيحة: <span class="correct-choice">${q.options[q.correctAnswer]}</span>`; optionsDiv.appendChild(correctAnswerP); }
                    if (q.explanation) { const explanationP = document.createElement('p'); explanationP.classList.add('explanation'); explanationP.innerHTML = `💡 <strong>شرح:</strong> ${q.explanation}`; optionsDiv.appendChild(explanationP); }
                    reviewItem.appendChild(optionsDiv);
                    if (isUserCorrect) { reviewItem.classList.add('correct-answer'); } 
                    else if (userAnswersArray[i] !== null) { reviewItem.classList.add('incorrect-answer'); }
                    reviewContainer.appendChild(reviewItem);
                });
            }

            nextBtn.addEventListener('click', nextQuestion);
            prevBtn.addEventListener('click', prevQuestion);
            markReviewBtn.addEventListener('click', toggleMarkReview);
            submitExamBtnMain.addEventListener('click', confirmSubmit);
            submitExamBtnSidebar.addEventListener('click', confirmSubmit);
            
            showWelcomePage(); 
        });
    </script>

</body>
</html>