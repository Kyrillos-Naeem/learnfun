<!DOCTYPE html>
<html lang="ar" dir="rtl"> <!-- lang and dir will be updated by JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة التعلم الذكي</title> <!-- This will be updated by JS -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark-primary: #10101A;
            --bg-dark-secondary: #1A1A2E;
            --bg-dark-tertiary: #24243E;
            --text-light-primary: #F0F0F8;
            --text-light-secondary: #A0A0C0;
            --accent-primary: #00A8E8;
            --accent-secondary: #007EA7;
            --accent-tertiary: #FFD700;
            --border-color: #30304A;
            --shadow-color-light: rgba(0, 168, 232, 0.2);
            --shadow-color-dark: rgba(0, 0, 0, 0.4);
            --font-ar: 'Cairo', sans-serif;
            --font-en: 'Roboto', sans-serif;
            /* --font-es removed as Spanish is no longer supported */
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            /* Default font set by JS based on language */
            background: linear-gradient(135deg, var(--bg-dark-primary) 0%, #181828 100%);
            color: var(--text-light-primary);
            line-height: 1.8;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Language Switcher --- */
        .language-switcher-container {
            position: fixed;
            top: 20px;
            right: 20px; 
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(16, 16, 26, 0.85);
            padding: 6px 12px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 4px 12px var(--shadow-color-dark);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: background-color 0.3s ease;
        }
        .language-switcher-container:hover {
            background-color: rgba(16, 16, 26, 0.95);
        }
        .language-label {
            color: var(--text-light-secondary);
            font-size: 1em;
            font-weight: 500;
            margin-inline-end: 4px;
        }
        #languageSelect {
            background-color: rgba(40, 40, 62, 0.8);
            color: var(--text-light-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px; 
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300A8E8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.7em top 50%, 0 0; /* Default LTR */
            background-size: .65em auto, 100%;
            padding-right: 2.5em; /* Default for LTR */
            padding-left: 0.7em;  /* Default for LTR */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #languageSelect:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--shadow-color-light);
        }
        #languageSelect:hover { background-color: rgba(50, 50, 72, 0.9); }
        #languageSelect option { background-color: var(--bg-dark-tertiary); color: var(--text-light-primary); }


        /* --- App Shell (same) --- */
        .app-shell { display: flex; flex-direction: column; flex-grow: 1; }

        /* --- Welcome Section (same styling, text will be dynamic) --- */
        .welcome-section {
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 80px 20px 60px 20px; min-height: 60vh;
            background: radial-gradient(circle, rgba(26,26,46,0.8) 0%, rgba(16,16,26,0.9) 70%),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.05"><path d="M10 10 Q20 0 30 10 T50 10 T70 10 T90 10 M10 30 Q20 20 30 30 T50 30 T70 30 T90 30 M10 50 Q20 40 30 50 T50 50 T70 50 T90 50 M10 70 Q20 60 30 70 T50 70 T70 70 T90 70 M10 90 Q20 80 30 90 T50 90 T70 90 T90 90" stroke="%23F0F0F8" fill="none" stroke-width="1"/></svg>');
            background-size: cover, 200px;
            animation: fadeInWelcome 1s ease-out;
        }
        @keyframes fadeInWelcome { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .welcome-section h1 { font-size: 3.5em; font-weight: 700; color: #ffffff; margin-bottom: 20px; letter-spacing: -1px; text-shadow: 0 2px 10px var(--shadow-color-dark); }
        .welcome-section .subtitle { font-size: 1.4em; color: var(--text-light-secondary); margin-bottom: 35px; max-width: 600px; }
        .cta-button { background-color: var(--accent-primary); color: #ffffff; padding: 15px 35px; font-size: 1.2em; font-weight: 600; border: none; border-radius: var(--border-radius-md); cursor: pointer; text-decoration: none; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 4px 15px rgba(0, 168, 232, 0.3); }
        .cta-button:hover { background-color: var(--accent-secondary); transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 168, 232, 0.4); }

        /* --- Main Content Area (same styling, text will be dynamic) --- */
        .main-content-area {
            width: 90%;
            max-width: 950px;
            margin: 0 auto 40px auto;
            padding: 30px 35px;
            background-color: var(--bg-dark-secondary);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 40px var(--shadow-color-dark);
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s cubic-bezier(0.4,0,0.2,1), transform 0.6s cubic-bezier(0.4,0,0.2,1), margin-top 0.6s cubic-bezier(0.4,0,0.2,1);
        }
        .main-content-area.visible {
            opacity: 1;
            transform: translateY(0);
            margin-top: -80px;
        }
        .content-header { text-align: center; margin-bottom: 30px; }
        .content-header h2 { font-size: 2.2em; color: var(--text-light-primary); margin-bottom: 10px; }
        .content-header p { color: var(--text-light-secondary); font-size: 1.1em; }
        .search-bar-container {
            position: relative;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
        }
        #mainSearchInput {
            width: 100%;
            padding: 16px 25px 16px 60px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            background-color: var(--bg-dark-tertiary);
            color: var(--text-light-primary);
            font-size: 1.1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        html[dir="ltr"] #mainSearchInput { padding: 16px 60px 16px 25px; }
        #mainSearchInput:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--shadow-color-light);
        }
        #mainSearchInput::placeholder { color: var(--text-light-secondary); opacity: 0.7; }
        .search-icon-main {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            color: var(--text-light-secondary);
            font-size: 1.5em;
            pointer-events: none;
        }
        html[dir="ltr"] .search-icon-main { right: auto; left: 20px; }
        .clear-search-btn {
            position: absolute;
            top: 50%;
            left: 45px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--accent-primary);
            font-size: 1.2em;
            cursor: pointer;
            display: none;
        }
        html[dir="ltr"] .clear-search-btn { left: auto; right: 45px; }
        .clear-search-btn.visible { display: block; }

        /* Department Cards (same styling, text will be dynamic) */
        .department-card {
            margin-bottom: 25px;
            border-radius: var(--border-radius-md);
            background-color: var(--bg-dark-tertiary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            transition: box-shadow 0.3s, transform 0.3s;
            outline: none;
        }
        .department-card:focus-within, .department-card:hover {
            transform: translateY(-3px) scale(1.01);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .department-header {
            background-image: linear-gradient(to right, var(--bg-dark-secondary), #202038);
            color: #ffffff;
            padding: 20px 25px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
            border-bottom: 1px solid var(--border-color);
            outline: none;
        }
        .department-header:focus, .department-header.active {
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
        }
        .department-header h3 { margin: 0; font-size: 1.6em; font-weight: 600; }
        .toggle-icon { font-size: 1.4em; transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); color: var(--accent-primary); }
        .department-header.active .toggle-icon { transform: rotate(135deg); color: #fff; }
        .subject-list { list-style: none; padding: 0; margin: 0; max-height: 0; overflow: hidden; transition: max-height 0.5s, padding 0.5s; background-color: var(--bg-dark-tertiary); }
        .department-header.active + .subject-list { max-height: 800px; padding: 10px 0; }
        .subject-item { padding: 15px 30px; border-top: 1px solid #2a2a42; transition: background-color 0.2s, padding-right 0.2s, padding-left 0.2s; border-radius: var(--border-radius-sm); }
        html[dir="ltr"] .subject-item:hover, html[dir="ltr"] .subject-item:focus-within { padding-left: 35px; padding-right: 30px; background-color: #2f2f4f; }
        html[dir="rtl"] .subject-item:hover, html[dir="rtl"] .subject-item:focus-within { padding-right: 35px; padding-left: 30px; background-color: #2f2f4f; }
        .subject-item:first-child { border-top: none; }
        .subject-item a { color: var(--accent-primary); text-decoration: none; display: flex; align-items: center; font-size: 1.1em; font-weight: 500; transition: color 0.2s; outline: none; }
        .subject-item a:focus, .subject-item a:hover { color: var(--accent-tertiary); text-decoration: underline; }
        .subject-item a .subject-icon { margin-left: 10px; font-size: 1.2em; }
        html[dir="ltr"] .subject-item a .subject-icon { margin-left: 0; margin-right: 10px; }
        .subject-item.hidden { display: none; }
        .no-results-message { text-align:center; padding:25px; color:var(--text-light-secondary); font-size:1.1em; }

        /* --- Footer (same styling, text will be dynamic) --- */
        .app-footer { text-align: center; padding: 30px 20px; margin-top: auto; background-color: var(--bg-dark-primary); border-top: 1px solid var(--border-color); }
        .app-footer .copyright { margin-top: 10px; font-size: 0.9em; color: #707090; }

        /* Placeholder Page (Modal-like for exam - text will be dynamic) */
        .placeholder-page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 16, 26, 0.85); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .placeholder-page-overlay.visible { opacity: 1; visibility: visible; }
        .placeholder-page-content { background-color: var(--bg-dark-secondary); padding: 30px 40px; border-radius: var(--border-radius-lg); width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 50px var(--shadow-color-dark); transform: scale(0.9); transition: transform 0.3s; position: relative; }
        .placeholder-page-overlay.visible .placeholder-page-content { transform: scale(1); }
        .placeholder-page-content h2 { color: #fff; margin-bottom: 20px; font-size: 1.8em;}
        .placeholder-page-content p, .placeholder-page-content ul { margin-bottom: 15px; line-height: 1.7; }
        .placeholder-page-content ul { padding-right: 20px; }
        html[dir="ltr"] .placeholder-page-content ul { padding-right: 0; padding-left: 20px; }
        .placeholder-page-content .close-btn {
            background-color: var(--accent-primary);
            color: #fff;
            border:none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            position: absolute;
            top: 15px;
            right: 15px;
            left: auto;
            z-index: 10;
            min-width: 44px;
            min-height: 44px;
        }
        html[dir="ltr"] .placeholder-page-content .close-btn { right: 15px; left: auto; }
        html[dir="rtl"] .placeholder-page-content .close-btn { left: 15px; right: auto; }
        .placeholder-page-content .close-btn:focus, .placeholder-page-content .close-btn:hover { background-color: var(--accent-secondary); outline: 2px solid var(--accent-tertiary); }

    </style>
</head>
<body>
    <div class="app-shell">
        <section class="welcome-section" id="welcome">
            <div class="language-switcher-container">
                <label for="languageSelect" class="language-label" id="languageLabel">🌐</label>
                <select id="languageSelect" aria-labelledby="languageLabel" title="Select language"></select>
            </div>
            <h1 data-translate-key="welcomeTitle"></h1>
            <p class="subtitle" data-translate-key="welcomeSubtitle"></p>
            <a href="#mainContent" class="cta-button" id="startExploringBtn" data-translate-key-text="exploreButton"></a>
        </section>

        <section class="main-content-area" id="mainContent">
            <header class="content-header">
                <h2 data-translate-key="sectionsTitle"></h2>
                <p data-translate-key="sectionsSubtitle"></p>
            </header>
            <div class="search-bar-container">
                <input type="text" id="mainSearchInput" data-translate-key-placeholder="searchInputPlaceholder" aria-label="Search" title="Search" placeholder="...">
                <span class="search-icon-main">🔍</span>
                <button class="clear-search-btn" id="clearSearchBtn" aria-label="Clear search" title="Clear search" tabindex="0" style="display:none;">×</button>
            </div>
            <div id="departmentsListContainer">
                <!-- Departments will be rendered here -->
            </div>
        </section>

        <footer class="app-footer">
            <p class="copyright" data-translate-key="copyright"></p>
        </footer>
    </div>

    <div class="placeholder-page-overlay" id="placeholderOverlay">
        <div class="placeholder-page-content" id="placeholderContent">
            <!-- Content will be injected here -->
        </div>
    </div>

    <script>
        // --- Supported Languages Configuration ---
        const supportedLanguages = {
            ar: { name: "العربية", dir: "rtl", font: "var(--font-ar)" },
            en: { name: "English", dir: "ltr", font: "var(--font-en)" }
            // es removed
        };

        // --- Translations Store ---
        const translations = {
            ar: {
                pageTitle: "بوابة التعلم الذكي",
                welcomeTitle: "بوابة التعلم الذكي",
                welcomeSubtitle: "مرحباً بك في منصتك المتكاملة لاستكشاف المواد الدراسية وخوض تجارب تعليمية فريدة. ابدأ رحلتك المعرفية الآن!",
                exploreButton: "ابدأ الاستكشاف الآن",
                sectionsTitle: "الأقسام الدراسية",
                sectionsSubtitle: "تصفح الأقسام المختلفة للعثور على المواد التي تهتم بها.",
                searchInputPlaceholder: "ابحث عن مادة أو قسم...",
                copyright: "© 2024 بوابة التعلم الذكي. جميع الحقوق محفوظة.",
                noResults: "عذراً، لم يتم العثور على أقسام أو مواد تطابق بحثك.",
                noSubjects: "لا توجد مواد متاحة حالياً.",
                examModalTitlePrefix: "محاكاة امتحان: ",
                examModalIntro: "أنت على وشك بدء محاكاة امتحان لمادة: ",
                examModalInstructionsTitle: "تعليمات هامة:",
                examModalInstruction1: "تأكد من فهمك لمادة الامتحان جيداً.",
                examModalInstruction2: "خصص وقتاً كافياً دون مقاطعات.",
                examModalInstruction3: "راجع إجاباتك قبل الإنهاء (في الامتحان الفعلي).",
                examModalStartButton: "بدء المحاكاة",
                closeButton: "إغلاق",
                deptToggleOpen: "−", deptToggleClose: "+",
            },
            en: {
                pageTitle: "Smart Learning Portal",
                welcomeTitle: "Smart Learning Portal",
                welcomeSubtitle: "Welcome to your integrated platform for exploring course materials and engaging in unique learning experiences. Start your knowledge journey now!",
                exploreButton: "Start Exploring Now",
                sectionsTitle: "Academic Departments",
                sectionsSubtitle: "Browse different departments to find the subjects you are interested in.",
                searchInputPlaceholder: "Search for a subject or department...",
                copyright: "© 2024 Smart Learning Portal. All rights reserved.",
                noResults: "Sorry, no departments or subjects found matching your search.",
                noSubjects: "No subjects currently available.",
                examModalTitlePrefix: "Exam Simulation: ",
                examModalIntro: "You are about to start an exam simulation for: ",
                examModalInstructionsTitle: "Important Instructions:",
                examModalInstruction1: "Ensure you understand the exam material well.",
                examModalInstruction2: "Allocate sufficient time without interruptions.",
                examModalInstruction3: "Review your answers before finishing (in a real exam).",
                examModalStartButton: "Start Simulation",
                closeButton: "Close",
                deptToggleOpen: "−", deptToggleClose: "+",
            }
            // es translations removed
        };

        // --- Department Data with Localized Names ---
        const departmentsData = [
            {
                id: "cs", icon: "💻",
                name: { ar: "علوم الحاسوب والذكاء الاصطناعي", en: "Computer Science & AI" /* es removed */ },
                subjects: [
                    { name: { ar: "مقدمة إلى بايثون والبرمجة الشيئية", en: "Intro to Python & OOP" /* es removed */ }, code: "CS101", icon: "🐍" },
                    { name: { ar: "هياكل البيانات المتقدمة والخوارزميات", en: "Advanced Data Structures & Algorithms" /* es removed */ }, code: "CS201", icon: "📊" },
                    { name: { ar: "تعلم الآلة وتطبيقاته", en: "Machine Learning & Applications" /* es removed */ }, code: "AI305", icon: "🤖" }
                ]
            },
            {
                id: "eng", icon: "⚙️",
                name: { ar: "الهندسة الميكانيكية والطاقة", en: "Mechanical Engineering & Energy" /* es removed */ },
                subjects: [
                    { name: { ar: "ديناميكا الموائع والحراريات", en: "Fluid Dynamics & Thermodynamics" /* es removed */ }, code: "ME202", icon: "🔥" },
                    { name: { ar: "تصميم الآلات باستخدام CAD/CAM", en: "Machine Design using CAD/CAM" /* es removed */ }, code: "ME305", icon: "🔩" }
                ]
            },
            {
                id: "business", icon: "📈",
                name: { ar: "إدارة الأعمال والتسويق الرقمي", en: "Business Admin & Digital Marketing" /* es removed */ },
                subjects: [
                    { name: { ar: "استراتيجيات التسويق الرقمي الحديث", en: "Modern Digital Marketing Strategies" /* es removed */ }, code: "BUS210", icon: "🌐" },
                    { name: { ar: "ريادة الأعمال وإدارة المشاريع الناشئة", en: "Entrepreneurship & Startup Management" /* es removed */ }, code: "BUS405", icon: "🚀" }
                ]
            }
        ];

        // --- DOM Elements ---
        const htmlEl = document.documentElement;
        const bodyEl = document.body;
        const languageSelect = document.getElementById('languageSelect');
        const startExploringBtn = document.getElementById('startExploringBtn');
        const mainContentArea = document.getElementById('mainContent');
        const departmentsListContainer = document.getElementById('departmentsListContainer');
        const mainSearchInput = document.getElementById('mainSearchInput');
        const placeholderOverlay = document.getElementById('placeholderOverlay');
        const placeholderContentDiv = document.getElementById('placeholderContent');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        // --- Language Initialization ---
        let currentLanguage = localStorage.getItem('portalLanguage');

        if (!currentLanguage || !supportedLanguages[currentLanguage]) {
            const browserLangFull = navigator.language || navigator.userLanguage || 'ar'; 
            const browserLangPrimary = browserLangFull.split('-')[0].toLowerCase(); 
            
            if (supportedLanguages[browserLangPrimary]) {
                currentLanguage = browserLangPrimary;
            } else {
                currentLanguage = 'ar'; // Default to Arabic if browser lang not 'ar' or 'en'
            }
            localStorage.setItem('portalLanguage', currentLanguage);
        }
        
        let departmentsRendered = false;

        // --- Functions ---
        function populateLanguageSelector() {
            languageSelect.innerHTML = ''; 
            Object.keys(supportedLanguages).forEach(langCode => {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = supportedLanguages[langCode].name;
                if (langCode === currentLanguage) {
                    option.selected = true;
                }
                languageSelect.appendChild(option);
            });
        }

        function applyTranslations() {
            const langConfig = supportedLanguages[currentLanguage];
            const trans = translations[currentLanguage];

            htmlEl.lang = currentLanguage;
            htmlEl.dir = langConfig.dir;
            bodyEl.style.fontFamily = langConfig.font;
            bodyEl.className = currentLanguage; 

            if (langConfig.dir === 'rtl') { 
                languageSelect.style.paddingLeft = '2.5em';
                languageSelect.style.paddingRight = '0.7em';
                languageSelect.style.backgroundPosition = 'left 0.7em top 50%, 0 0';
            } else { 
                languageSelect.style.paddingRight = '2.5em';
                languageSelect.style.paddingLeft = '0.7em';
                languageSelect.style.backgroundPosition = 'right 0.7em top 50%, 0 0';
            }

            document.title = trans.pageTitle;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (trans[key]) el.innerHTML = trans[key];
            });
            document.querySelectorAll('[data-translate-key-text]').forEach(el => {
                const key = el.dataset.translateKeyText;
                if (trans[key]) el.textContent = trans[key];
            });
            document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.dataset.translateKeyPlaceholder;
                if (trans[key]) el.placeholder = trans[key];
            });
            
            if (departmentsRendered) {
                renderDepartments();
                if (mainSearchInput.value) filterContent();
            }
        }
        
        function handleLanguageChange(event) {
            currentLanguage = event.target.value;
            localStorage.setItem('portalLanguage', currentLanguage); 
            applyTranslations();
        }

        function updateClearSearchBtn() {
            if (mainSearchInput.value) {
                clearSearchBtn.classList.add('visible');
                clearSearchBtn.style.display = 'block';
            } else {
                clearSearchBtn.classList.remove('visible');
                clearSearchBtn.style.display = 'none';
            }
        }

        function renderDepartments(filteredData) {
            const lang = currentLanguage;
            const dataToRender = filteredData || departmentsData;
            const langConfig = supportedLanguages[lang]; // Get langConfig here

            departmentsListContainer.innerHTML = '';
            if (dataToRender.length === 0) {
                departmentsListContainer.innerHTML = `<p class="no-results-message">${translations[lang].noResults}</p>`;
                return;
            }

            dataToRender.forEach(dept => {
                const departmentCard = document.createElement('div');
                departmentCard.className = 'department-card';
                departmentCard.tabIndex = 0;
                departmentCard.setAttribute('role', 'region');
                departmentCard.setAttribute('aria-label', dept.name[lang]);

                const headerDiv = document.createElement('div');
                headerDiv.className = 'department-header';
                headerDiv.setAttribute('aria-expanded', 'false');
                headerDiv.setAttribute('aria-controls', `subjects-${dept.id}`);
                headerDiv.tabIndex = 0;
                headerDiv.setAttribute('role', 'button');
                headerDiv.setAttribute('aria-label', dept.name[lang]);
                headerDiv.innerHTML = `
                    <h3><span class="dept-icon" style="margin-${langConfig.dir === 'rtl' ? 'left':'right'}:8px;">${dept.icon || '📚'}</span> ${dept.name[lang]}</h3>
                    <span class="toggle-icon">${translations[lang].deptToggleClose}</span>
                `;
                
                const subjectListUl = document.createElement('ul');
                subjectListUl.className = 'subject-list';
                subjectListUl.id = `subjects-${dept.id}`;

                if (dept.subjects.length > 0) {
                    dept.subjects.forEach(subject => {
                        const subjectLi = document.createElement('li');
                        subjectLi.className = 'subject-item';
                        Object.keys(supportedLanguages).forEach(langKey => { // This will now only iterate ar, en
                            if(subject.name[langKey]) {
                                subjectLi.dataset[`subjectName${langKey.charAt(0).toUpperCase() + langKey.slice(1)}`] = `${subject.name[langKey].toLowerCase()} ${subject.code.toLowerCase()}`;
                            }
                        });
                        subjectLi.innerHTML = `<a href="#exam/${subject.code}" onclick="showExamSimulationPage('${subject.name[lang]}', '${subject.code}'); return false;"><span class="subject-icon">${subject.icon || '📖'}</span>${subject.name[lang]} (${subject.code})</a>`;
                        subjectListUl.appendChild(subjectLi);
                    });
                } else {
                     subjectListUl.innerHTML = `<li class="subject-item" style="text-align:center; color:var(--text-light-secondary);">${translations[lang].noSubjects}</li>`;
                }

                departmentCard.appendChild(headerDiv);
                departmentCard.appendChild(subjectListUl);
                departmentsListContainer.appendChild(departmentCard);

                headerDiv.addEventListener('click', function() {
                    const isActive = this.classList.toggle('active');
                    this.setAttribute('aria-expanded', isActive.toString());
                    const icon = this.querySelector('.toggle-icon');
                    const currentSelectedLang = currentLanguage; 
                    icon.textContent = isActive ? translations[currentSelectedLang].deptToggleOpen : translations[currentSelectedLang].deptToggleClose;
                });
                headerDiv.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.click();
                    }
                });
            });
            departmentsRendered = true;
            
            document.querySelectorAll('.dept-icon').forEach(icon => {
                icon.style.margin = ''; 
                icon.style[`margin-${langConfig.dir === 'rtl' ? 'left' : 'right'}`] = '8px';
            });
        }

        function filterContent() {
            const searchTerm = mainSearchInput.value.toLowerCase().trim();
            const lang = currentLanguage;

            const displayData = departmentsData.map(dept => {
                const deptNameMatches = dept.name[lang].toLowerCase().includes(searchTerm);
                const filteredSubjects = dept.subjects.filter(subject =>
                    `${subject.name[lang].toLowerCase()} ${subject.code.toLowerCase()}`.includes(searchTerm)
                );

                if (deptNameMatches || filteredSubjects.length > 0) {
                    return {
                        ...dept,
                        subjects: (filteredSubjects.length > 0) ? filteredSubjects : (deptNameMatches ? dept.subjects : [])
                    };
                }
                return null;
            }).filter(dept => dept !== null);

            renderDepartments(displayData);

            if (searchTerm) {
                document.querySelectorAll('.department-card').forEach(card => {
                    const header = card.querySelector('.department-header');
                    const subjectList = card.querySelector('.subject-list');
                    if (subjectList.children.length > 0 && !header.classList.contains('active')) {
                        let hasRealSubjects = false;
                        for(let item of subjectList.children) { if(item.querySelector('a')) { hasRealSubjects = true; break; } }
                        if(hasRealSubjects) { 
                            if (!header.classList.contains('active')) {
                                header.click();
                            }
                        }
                    }
                });
            }
        }
        
        window.showInfoPage = function(title, contentHTML, closeButtonTextKey = 'closeButton') {
            const lang = currentLanguage;
            placeholderContentDiv.innerHTML = `
                <button class="close-btn" onclick="hideInfoPage()" aria-label="${translations[lang][closeButtonTextKey]}" title="${translations[lang][closeButtonTextKey]}" tabindex="0">×</button>
                <h2>${title}</h2>
                ${contentHTML}
            `;
            placeholderOverlay.classList.add('visible');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                const closeBtn = placeholderContentDiv.querySelector('.close-btn');
                if (closeBtn) closeBtn.focus();
            }, 100);
        }

        window.hideInfoPage = function() {
            placeholderOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }

        window.showExamSimulationPage = function(subjectName, subjectCode) {
            const lang = currentLanguage;
            const trans = translations[lang];
            let exampleParagraph = ""; 
            if (lang === 'ar') exampleParagraph = "<p>هذه واجهة توضيحية. في التطبيق الفعلي، سيتم عرض أسئلة الامتحان هنا.</p>";
            else if (lang === 'en') exampleParagraph = "<p>This is a demonstrative interface. In a real application, exam questions would be displayed here.</p>";
            // es paragraph removed

            const examContent = `
                <p>${trans.examModalIntro}<strong>${subjectName} (${subjectCode})</strong>.</p>
                ${exampleParagraph}
                <div style="margin-top: 25px; padding: 20px; border: 1px dashed var(--border-color); border-radius: var(--border-radius-sm); background-color: #1c1c32;">
                    <h4>${trans.examModalInstructionsTitle}</h4>
                    <ul>
                        <li>${trans.examModalInstruction1}</li>
                        <li>${trans.examModalInstruction2}</li>
                        <li>${trans.examModalInstruction3}</li>
                    </ul>
                    <button style="margin-top:20px; padding: 12px 25px; background-color: #28a745; color:white; border:none; border-radius:var(--border-radius-sm); cursor:pointer; font-size:1em;">${trans.examModalStartButton}</button>
                </div>
            `;
            showInfoPage(`${trans.examModalTitlePrefix}${subjectName}`, examContent);
        }

        // --- Event Listeners ---
        languageSelect.addEventListener('change', handleLanguageChange);

        startExploringBtn.addEventListener('click', (e) => {
            e.preventDefault();
            mainContentArea.classList.add('visible');
            setTimeout(() => { mainContentArea.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 100);
            if (!departmentsRendered) renderDepartments();
        });

        mainSearchInput.addEventListener('input', function() {
            updateClearSearchBtn();
            filterContent();
        });
        clearSearchBtn.addEventListener('click', function() {
            mainSearchInput.value = '';
            updateClearSearchBtn();
            filterContent();
            mainSearchInput.focus();
        });
        mainSearchInput.addEventListener('focus', updateClearSearchBtn);
        mainSearchInput.addEventListener('blur', function() {
            setTimeout(updateClearSearchBtn, 200); 
        });
        
        placeholderOverlay.addEventListener('click', (e) => {
            if (e.target === placeholderOverlay) hideInfoPage();
        });

        // --- Initial Load ---
        populateLanguageSelector(); 
        applyTranslations();      
        updateClearSearchBtn();

    </script>
</body>
</html>
